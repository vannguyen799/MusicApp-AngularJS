<!DOCTYPE html>
<html lang="en" ng-app="musicApp">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            :root {
                --bg-color: rgb(37, 39, 40);
                --txt-color: rgb(212, 212, 212);
                --header-h: 40px;
                --line-color: #1a73e8;
            }
            body,
            html {
                font-family: Open Sans, sans-serif;
                font-size: small;
                font-weight: 500;
                margin: 0;
                padding: 0;
                height: 100%;
                color: var(--txt-color);
                background-color: var(--bg-color);
                overflow: hidden;
            }
            .text-truncate {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 200px;
            }
            th,
            td {
                border-bottom: 1px solid rgba(231, 231, 231, 0.504);
                padding: 8px;
                text-align: left;
            }
            .header {
                position: sticky;
                top: 0;
                z-index: 1000;
                width: 100%;
                text-align: center;
                align-items: center;
                background-color: #333;
                height: var(--header-h);
            }
            .playlist-container {
                flex: 1;
                width: 100%;
                padding-top: 10px;
                padding-left: 20px;
                right: 0;
                overflow-x: hidden;
                overflow-y: auto;
                max-height: 82vh;
            }
            .playlist-container::-webkit-scrollbar {
                width: 0;
                /* Ẩn thanh cuộn ngang */
                height: 0;
                /* Ẩn thanh cuộn dọc */
            }
            .playlist-container::-webkit-scrollbar-thumb {
                background: transparent;
                /* Ẩn phần tay cầm của thanh cuộn */
            }
            .playlist-container::-webkit-scrollbar-track {
                background: transparent;
                /* Ẩn phần nền của thanh cuộn */
            }
            .playlist-top {
                position: sticky;
                top: 0;
                /* Định vị tiêu đề bảng cố định khi cuộn */
                z-index: 1;
                /* Đảm bảo tiêu đề nằm trên nội dung */
                fill: inherit;
            }
            .song-table {
                overflow-x: hidden;
                overflow-y: auto;
                max-height: 300px;
            }
            .song-table::-webkit-scrollbar {
                width: 10px;
                /* Chiều rộng thanh cuộn */
            }
            .song-table::-webkit-scrollbar-track {
                background-color: #909090;
                /* Màu nền của track thanh cuộn */
                border-radius: 10px;
                /* Bo góc track thanh cuộn */
            }
            .song-table::-webkit-scrollbar-thumb {
                background-color: #464646;
                /* Màu của thanh cuộn */
                border-radius: 10px;
                /* Bo góc thanh cuộn */
            }
            /* .song-table::-webkit-scrollbar-thumb:hover {
                background-color: #a0a0a0; 
            } */
            .song-table th {
                position: sticky;
                top: 0;
                z-index: 2;
                fill: inherit;
                background-color: var(--bg-color);
            }
            .song-table tr:hover {
                background-color: #90909040;
            }
            .managePlaylistForm {
                border: 1px solid #444444;
                padding: 10px;
            }
            .managePlaylistForm > div {
                margin: 7px;
            }
            .table-action {
                margin: 5px;
                width: 100%;
                display: flex;
            }
            .table-action * {
                margin-right: 20px;
            }
            .table-action select {
                justify-self: end;
                margin-left: auto;
            }
        </style>
        <style>
            .footer > button {
                z-index: 11000;
                position: fixed;
                right: 1%;
                left: auto;
                bottom: 3%;
            }
        </style>
        <style>
            /* Base styles for all icons */
            .icon {
                width: 23px;
                height: 23px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                outline: none;
                background-color: transparent;
                transition: background-color 0.2s, transform 0.2s;
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                filter: invert(0.9) sepia(0.1) saturate(2) hue-rotate(180deg) brightness(1.2);
            }
            /* Individual icons */
            .icon-play {
                background-image: url("https://www.svgrepo.com/download/246478/play-button.svg");
            }

            .icon-pause {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' fill='%23000000' height='800px' width='800px' version='1.1' id='Layer_1' viewBox='0 0 511.999 511.999' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cpath d='M256.001,0C114.509,0,0,114.497,0,255.999C0,397.49,114.497,511.999,255.999,511.999 c141.492,0,255.999-114.496,255.999-255.999C512,114.511,397.503,0,256.001,0z M256.001,478.252 c-122.55,0-222.252-99.702-222.252-222.252S133.451,33.748,256.001,33.748s222.251,99.701,222.251,222.251 S378.55,478.252,256.001,478.252z'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cg%3E%3Cpath d='M197.58,138.901c-26.221,0-47.554,21.332-47.554,47.554v139.09c0,26.221,21.332,47.553,47.554,47.553 s47.553-21.332,47.553-47.553V186.456C245.134,160.234,223.801,138.901,197.58,138.901z M211.385,325.546 c0,7.612-6.193,13.805-13.805,13.805s-13.805-6.193-13.805-13.805v-139.09c0-7.612,6.193-13.805,13.805-13.805 s13.805,6.193,13.805,13.805V325.546z'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cg%3E%3Cpath d='M314.42,138.901c-26.222,0-47.554,21.332-47.554,47.554v139.09c0,26.221,21.332,47.553,47.554,47.553 s47.554-21.332,47.554-47.553V186.456C361.973,160.234,340.641,138.901,314.42,138.901z M328.225,325.546 c0,7.612-6.194,13.805-13.805,13.805s-13.805-6.193-13.805-13.805v-139.09c0-7.612,6.194-13.805,13.805-13.805 s13.805,6.193,13.805,13.805V325.546z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-fav {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' version='1.2' viewBox='0 0 24 24' width='800' height='800'%3E%3Ctitle%3Estar-circle-svgrepo-com (1)-svg%3C/title%3E%3Cstyle%3E .s0 %7B fill: %23000000;stroke: %23000000;stroke-width: .4 %7D %3C/style%3E%3Cg id='SVGRepo_bgCarrier'%3E%3C/g%3E%3Cg id='SVGRepo_tracerCarrier'%3E%3C/g%3E%3Cg id='SVGRepo_iconCarrier'%3E%3Cpath fill-rule='evenodd' class='s0' d='m16.5 1.1c1.4 0.6 2.7 1.5 3.8 2.6 1.1 1.1 2 2.4 2.6 3.8 0.6 1.4 0.9 3 0.9 4.5 0 4.8-2.9 9-7.3 10.9-4.4 1.8-9.5 0.8-12.8-2.6-3.4-3.3-4.4-8.4-2.6-12.8 1.9-4.4 6.1-7.3 10.9-7.3 1.5 0 3.1 0.3 4.5 0.9zm-0.4 20.7c1.2-0.5 2.4-1.3 3.4-2.3 1-1 1.8-2.2 2.3-3.4 0.5-1.3 0.8-2.7 0.8-4.1 0-4.3-2.6-8.2-6.5-9.8-4-1.7-8.6-0.7-11.6 2.3-3 3-4 7.6-2.3 11.6 1.6 3.9 5.5 6.5 9.8 6.5 1.4 0 2.8-0.3 4.1-0.8zm2.5-11.9q0.1 0.1 0.2 0.3 0.1 0.3 0 0.5-0.1 0.2-0.2 0.3l-3.1 2.6 1 3.9q0 0.1 0 0.2 0 0.1 0 0.2-0.1 0.1-0.1 0.2-0.1 0.1-0.2 0.2 0 0-0.1 0 0 0.1-0.1 0.1 0 0-0.1 0 0 0-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0l-3.4-2.1-3.4 2.1q-0.2 0.1-0.5 0.1-0.2 0-0.4-0.1-0.1-0.2-0.2-0.4-0.1-0.2 0-0.4l0.9-3.9-3-2.6q-0.2-0.1-0.3-0.3 0-0.2 0-0.5 0.1-0.2 0.3-0.3 0.2-0.1 0.4-0.1l4-0.4 1.5-3.7q0.1-0.2 0.3-0.3 0.2-0.1 0.4-0.1 0.2 0 0.4 0.1 0.2 0.1 0.2 0.3l1.6 3.7 3.9 0.4q0.3 0 0.5 0.1zm-1.6 0.9l-3.6-0.3-1.4-3.4-1.5 3.4-3.6 0.3 2.8 2.4-0.9 3.6 3.2-1.9 3.1 1.9-0.8-3.6z'/%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-loading {
                background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Ccircle fill='%2523000000' stroke='%2523000000' stroke-width='15' r='15' cx='40' cy='65'%3E%3Canimate attributeName='cy' calcMode='spline' dur='2' values='65;135;65;' keySplines='.5 0 .5 1;.5 0 .5 1' repeatCount='indefinite' begin='-.4'%3E%3C/animate%3E%3C/circle%3E%3Ccircle fill='%2523000000' stroke='%2523000000' stroke-width='15' r='15' cx='100' cy='65'%3E%3Canimate attributeName='cy' calcMode='spline' dur='2' values='65;135;65;' keySplines='.5 0 .5 1;.5 0 .5 1' repeatCount='indefinite' begin='-.2'%3E%3C/animate%3E%3C/circle%3E%3Ccircle fill='%2523000000' stroke='%2523000000' stroke-width='15' r='15' cx='160' cy='65'%3E%3Canimate attributeName='cy' calcMode='spline' dur='2' values='65;135;65;' keySplines='.5 0 .5 1;.5 0 .5 1' repeatCount='indefinite' begin='0'%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E%0A");
            }

            .icon-unfav {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' version='1.2' viewBox='0 0 56 56' width='800' height='800'%3E%3Ctitle%3Estar-circle-fill-svg%3C/title%3E%3Cstyle%3E .s0 %7B fill: %23000000 %7D %3C/style%3E%3Cpath fill-rule='evenodd' class='s0' d='m28 56c-15.5 0-28-12.5-28-28 0-15.5 12.5-28 28-28 15.5 0 28 12.5 28 28 0 15.5-12.5 28-28 28zm-8.5-13.1l8.5-6.2 8.5 6.2c1 0.7 1.8 0.9 2.5 0.4q0.9-0.7 0.3-2.4l-3.3-10 8.6-6.2c0.9-0.7 1.3-1.4 1.1-2.2q-0.4-1.1-2.2-1.1l-10.6 0.1-3.2-10.1c-0.3-1.1-0.9-1.7-1.7-1.7-0.8 0-1.4 0.6-1.7 1.7l-3.2 10.1-10.6-0.1c-1.2 0-1.9 0.4-2.2 1.1-0.2 0.8 0.2 1.5 1.1 2.2l8.6 6.2-3.3 10q-0.6 1.7 0.3 2.4c0.7 0.5 1.5 0.3 2.5-0.4z'/%3E%3C/svg%3E");
            }

            .icon-add {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:sketch='http://www.bohemiancoding.com/sketch/ns' width='800px' height='800px' viewBox='0 0 32 32' version='1.1'%3E%3Ctitle%3Eplus-circle%3C/title%3E%3Cdesc%3ECreated with Sketch Beta.%3C/desc%3E%3Cdefs%3E%3C/defs%3E%3Cg id='Page-1' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' sketch:type='MSPage'%3E%3Cg id='Icon-Set' sketch:type='MSLayerGroup' transform='translate(-464.000000, -1087.000000)' fill='%23000000'%3E%3Cpath d='M480,1117 C472.268,1117 466,1110.73 466,1103 C466,1095.27 472.268,1089 480,1089 C487.732,1089 494,1095.27 494,1103 C494,1110.73 487.732,1117 480,1117 L480,1117 Z M480,1087 C471.163,1087 464,1094.16 464,1103 C464,1111.84 471.163,1119 480,1119 C488.837,1119 496,1111.84 496,1103 C496,1094.16 488.837,1087 480,1087 L480,1087 Z M486,1102 L481,1102 L481,1097 C481,1096.45 480.553,1096 480,1096 C479.447,1096 479,1096.45 479,1097 L479,1102 L474,1102 C473.447,1102 473,1102.45 473,1103 C473,1103.55 473.447,1104 474,1104 L479,1104 L479,1109 C479,1109.55 479.447,1110 480,1110 C480.553,1110 481,1109.55 481,1109 L481,1104 L486,1104 C486.553,1104 487,1103.55 487,1103 C487,1102.45 486.553,1102 486,1102 L486,1102 Z' id='plus-circle' sketch:type='MSShapeGroup'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-remove {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:sketch='http://www.bohemiancoding.com/sketch/ns' width='800px' height='800px' viewBox='0 0 32 32' version='1.1'%3E%3Ctitle%3Ecross-circle%3C/title%3E%3Cdesc%3ECreated with Sketch Beta.%3C/desc%3E%3Cdefs%3E%3C/defs%3E%3Cg id='Page-1' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' sketch:type='MSPage'%3E%3Cg id='Icon-Set-Filled' sketch:type='MSLayerGroup' transform='translate(-570.000000, -1089.000000)' fill='%23000000'%3E%3Cpath d='M591.657,1109.24 C592.048,1109.63 592.048,1110.27 591.657,1110.66 C591.267,1111.05 590.633,1111.05 590.242,1110.66 L586.006,1106.42 L581.74,1110.69 C581.346,1111.08 580.708,1111.08 580.314,1110.69 C579.921,1110.29 579.921,1109.65 580.314,1109.26 L584.58,1104.99 L580.344,1100.76 C579.953,1100.37 579.953,1099.73 580.344,1099.34 C580.733,1098.95 581.367,1098.95 581.758,1099.34 L585.994,1103.58 L590.292,1099.28 C590.686,1098.89 591.323,1098.89 591.717,1099.28 C592.11,1099.68 592.11,1100.31 591.717,1100.71 L587.42,1105.01 L591.657,1109.24 L591.657,1109.24 Z M586,1089 C577.163,1089 570,1096.16 570,1105 C570,1113.84 577.163,1121 586,1121 C594.837,1121 602,1113.84 602,1105 C602,1096.16 594.837,1089 586,1089 L586,1089 Z' id='cross-circle' sketch:type='MSShapeGroup'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-select {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:sketch='http://www.bohemiancoding.com/sketch/ns' width='800px' height='800px' viewBox='0 0 32 32' version='1.1'%3E%3Ctitle%3Earrow-up-circle%3C/title%3E%3Cdesc%3ECreated with Sketch Beta.%3C/desc%3E%3Cdefs%3E%3C/defs%3E%3Cg id='Page-1' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' sketch:type='MSPage'%3E%3Cg id='Icon-Set' sketch:type='MSLayerGroup' transform='translate(-360.000000, -1087.000000)' fill='%23000000'%3E%3Cpath d='M376,1117 C368.268,1117 362,1110.73 362,1103 C362,1095.27 368.268,1089 376,1089 C383.732,1089 390,1095.27 390,1103 C390,1110.73 383.732,1117 376,1117 L376,1117 Z M376,1087 C367.163,1087 360,1094.16 360,1103 C360,1111.84 367.163,1119 376,1119 C384.837,1119 392,1111.84 392,1103 C392,1094.16 384.837,1087 376,1087 L376,1087 Z M376.879,1096.46 C376.639,1096.22 376.311,1096.15 376,1096.21 C375.689,1096.15 375.361,1096.22 375.121,1096.46 L369.465,1102.12 C369.074,1102.51 369.074,1103.14 369.465,1103.54 C369.854,1103.93 370.488,1103.93 370.879,1103.54 L375,1099.41 L375,1110 C375,1110.55 375.447,1111 376,1111 C376.553,1111 377,1110.55 377,1110 L377,1099.41 L381.121,1103.54 C381.512,1103.93 382.145,1103.93 382.535,1103.54 C382.926,1103.14 382.926,1102.51 382.535,1102.12 L376.879,1096.46 L376.879,1096.46 Z' id='arrow-up-circle' sketch:type='MSShapeGroup'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon:hover {
                /* background-color: rgba(0, 0, 0, 0.1); */
                transform: scale(1.1);
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-sanitize.min.js"></script>
        <script>
            function appsScriptRun({
                funtionName,
                input = [],
                userObj,
                onSuccess = (result, userObj = undefined) => {
                    console.log("success" + result);
                },
                onError = (result, userObj = undefined) => {
                    console.log("fail" + result);
                },
            }) {
                let runner = google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onError);
                if (userObj) {
                    runner.withUserObject(userObj);
                }
                runner[funtionName](...input);
            }
            async function appsScriptRunAsync(functionName, args) {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        [functionName](...args);
                });
            }
            const isAppsScript = window.location.host.endsWith("-script.googleusercontent.com");
            const isiOS = ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"].includes(navigator.platform) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        </script>
    </head>

    <body ng-controller="MusicAppController as ctrl">
        <div class="header">
            <!-- <nav class="navbar navbar-expand-lg navbar-dark d-none d-lg-block px-4" style="z-index: 2000"> -->
            <nav class="navbar navbar-expand-lg navbar-dark px-4" style="z-index: 2000">
                <div class="container-fluid">
                    <!-- <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button> -->
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item mx-2">
                                <button class="nav-link" ng-click="ctrl.selectSheetBtnHandler('')">All Song</button>
                            </li>

                            <li class="nav-item mx-2" ng-repeat="name in ctrl.sheetNames">
                                <button ng-class="{ 'nav-link active': name == ctrl.sheet, 'nav-link': name != ctrl.sheet }" ng-click="ctrl.selectSheetBtnHandler(name)">{{name}}</button>
                            </li>
                        </ul>
                        <ul class="navbar-nav list-inline">
                            <li class="nav-item mx-2">
                                <a class="nav-link" href="https://github.com/vannguyen799/MusicApp-AngularJS" target="_blank"> Github </a>
                            </li>
                            <li class="nav-item mx-2">
                                <button class="nav-link" ng-click="ctrl.menu.hidden = !ctrl.menu.hidden">Menu</button>
                            </li>
                            <li class="nav-item mx-2">
                                <button class="nav-link" ng-if="!ctrl.authToken" ng-click="ctrl.enableUpdateBtnHandler()">enableUpdate</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <style>
            .container.self-container {
                padding-top: 15px;
                padding-left: 3%;
                padding-right: 3%;
                max-width: 100%;
                position: relative;
            }
        </style>
        <div class="container self-container">
            <div class="row">
                <div class="col-sm-8" style="border-right: #a0a0a0 thin solid; min-height: 75vh">
                    <style>
                        #menu .card {
                            border-radius: 8px;
                            width: 25%;
                            height: 80px;
                            background-color: var(--bg-color);
                            color: var(--txt-color);
                            border: 1px solid var(--txt-color);
                        }
                        #menu .card:hover {
                            background-color: rgba(95, 239, 247, 0.237);
                            transform: scale(1.04);
                        }
                    </style>
                    <div id="menu">
                        <h1 ng-click="ctrl.menu.hidden = true">Category</h1>
                        <div class="w-100 mx-4" style="display: flex; flex-wrap: wrap">
                            <div class="card m-3 p-1" ng-click="ctrl.selectSheetBtnHandler('')">
                                <div class="card-body">
                                    <h5 class="card-title">All Song</h5>
                                    <p class="card-text"></p>
                                </div>
                            </div>
                            <div class="card m-3 p-1" ng-repeat="name in ctrl.sheetNames" ng-click="ctrl.selectSheetBtnHandler(name)">
                                <div class="card-body">
                                    <h5 class="card-title">{{name}}</h5>
                                    <p class="card-text"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h1 style="align-items: center; justify-items: center; display: flex">{{ctrl.sheet}} <button style="margin-left: 10px" ng-click="ctrl.playSongList()" ng-if="ctrl.songList" class="icon icon-play"></button></h1>
                        <div style="margin-top: 20px" ng-if="ctrl.message">{{ctrl.message}}</div>

                        <div ng-if="ctrl.songList">
                            <div class="table-action">
                                <label> search: <input name="" placeholder="search" style="border-radius: 10%" ng-model="ctrl.searchValue" /> </label>
                                <style>
                                    .sort-cbx {
                                        justify-self: left;
                                        border-radius: 10%;
                                    }
                                </style>
                                <select class="sort-cbx" ng-model="ctrl.sortBy">
                                    <option value="">--Sort--</option>
                                    <option value="name-asc">Sort by name asc</option>
                                    <option value="name-desc">Sort by name desc</option>
                                    <option value="singer-asc">Sort by singer asc</option>
                                    <option value="singer-desc">Sort by singer desc</option>
                                    <option value="listens-asc">Sort by listens asc</option>
                                    <option value="listens-desc">Sort by listens desc</option>
                                </select>
                            </div>
                            <style>
                                .song-action {
                                    display: flex;
                                    justify-content: flex-end;
                                    align-items: flex-end;
                                }
                                .song-action button {
                                    margin-right: 10px;
                                }
                            </style>
                            <div class="song-table songlisttable" style="min-height: 70vh">
                                <table>
                                    <tr>
                                        <th style="width: 40%">Name</th>
                                        <th class="w-25">Singer</th>
                                        <th style="width: 5%">Listens</th>
                                        <th class="" style="width: 13%">Action</th>
                                    </tr>
                                    <tr ng-repeat="s in ctrl.songList" ng-dblclick="ctrl.form.manageSong.init(s).show()">
                                        <!-- <td>{{i + 1}}</td> -->
                                        <td>
                                            {{s.vname == "" ? s.name : s.vname}}
                                            <div class="badge rounded-pill text-bg-secondary" ng-if="syncedLyricRegex.test(s.lyric)">Lyric</div>
                                            <div class="badge rounded-pill text-bg-secondary" ng-if="syncedLyricRegex.test(s.lyric_vn)">Vietsub</div>
                                            <div class="badge rounded-pill text-bg-secondary" ng-if="syncedLyricRegex.test(s.lyric_en)">Engsub</div>
                                        </td>
                                        <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>
                                        <td>{{s.listens}}</td>
                                        <td>
                                            <div class="song-action">
                                                <button
                                                    ng-click="ctrl.form.managePlaylist.addHandler(s)"
                                                    ng-if="ctrl.form.managePlaylist.isOpen"
                                                    ng-class="{
                                                        'icon icon-add': !ctrl.form.managePlaylist.isAdded(s),
                                                        'icon icon-remove': ctrl.form.managePlaylist.isAdded(s)
                                                    }"
                                                    title="PlayList"
                                                ></button>
                                                <button
                                                    ng-click="ctrl.player.playHandler(s, ctrl.songList)"
                                                    ng-class="{
                                                        'icon icon-play': s.fileId != ctrl.player.songInfo.fileId || (s.fileId == ctrl.player.songInfo.fileId && ctrl.player.audio.paused),
                                                        'icon icon-pause': s.fileId == ctrl.player.songInfo.fileId && !ctrl.player.audio.paused
                                                    }"
                                                    title="Play"
                                                ></button>
                                                <button
                                                    ng-click="ctrl.setSongFavorite(s)"
                                                    ng-class="{
                                                        'icon icon-fav': !s.isFavorite && !s.isLoadingFav,
                                                        'icon icon-unfav': s.isFavorite && !s.isLoadingFav,
                                                        'icon icon-loading': s.isLoadingFav,
                                                    }"
                                                    title="Favorite"
                                                ></button>
                                                <!-- <button ng-click="ctrl.form.manageSong.init(s).show()" class="icon icon-select" title="Update"></button> -->
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <style>
                        .modal,
                        .modal-backdrop {
                            position: absolute !important;
                        }
                    </style>
                    <div class="modal fade" id="manageSongForm" tabindex="-1" aria-labelledby="manageSongFormLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl" style="color: #444444; font-weight: bold">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="manageSongFormLabel">UpdateSong</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form>
                                        <div class="mb-3">
                                            <a target="_blank" href="https://drive.google.com/file/d/{{ctrl.form.manageSong.songInfo.fileId}}/view?usp=drivesdk">https://drive.google.com/file/d/{{ctrl.form.manageSong.songInfo.fileId}}/view?usp=drivesdk</a>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-sm-6">
                                                <label for="_singer" class="form-label">Singer</label>
                                                <input type="text" class="form-control" id="_singer" ng-model="ctrl.form.manageSong.songInfo.singer" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="_vsinger" class="form-label">VSinger</label>
                                                <input type="text" class="form-control" id="_vsinger" ng-model="ctrl.form.manageSong.songInfo.vsinger" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-6">
                                                <label for="_name" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="_name" ng-model="ctrl.form.manageSong.songInfo.name" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="_vname" class="form-label">VName</label>
                                                <input type="text" class="form-control" id="_vname" ng-model="ctrl.form.manageSong.songInfo.vname" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4">
                                                <label for="_lrc" class="form-label">Lyric</label>
                                                <textarea rows="10" class="form-control" id="_lrc" ng-model="ctrl.form.manageSong.songInfo.lyric"> </textarea>
                                            </div>
                                            <div class="col-sm-4">
                                                <label for="_lrc_vn" class="form-label">Lyric Vietsub</label>
                                                <textarea rows="10" class="form-control" id="_lrc_vn" ng-model="ctrl.form.manageSong.songInfo.lyric_vn"> </textarea>
                                            </div>
                                            <div class="col-sm-4">
                                                <label for="_lrc_en" class="form-label">Lyric Engsub</label>
                                                <textarea rows="10" class="form-control" id="_lrc_en" ng-model="ctrl.form.manageSong.songInfo.lyric_en"> </textarea>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" ng-click="ctrl.form.manageSong.update()">Update</button>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <!-- <button type="button" class="btn btn-primary">Understood</button> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4 playlist-container">
                    <div class="playlist-top">
                        <h3>Playlist</h3>
                        <button ng-click="ctrl.showCreatePlaylistForm()" class="btn btn-light">{{ctrl.form.managePlaylist.isOpen ? 'CloseForm' : 'Create'}}</button>
                    </div>
                    <div class="managePlaylistForm" ng-if="ctrl.form.managePlaylist.isOpen">
                        <h3>{{ctrl.form.managePlaylist.id ? 'Update' : 'Create'}} Playlist</h3>
                        <button ng-click="ctrl.playPlaylistHandler(ctrl.form.managePlaylist.getPlaylist())" ng-if="ctrl.form.managePlaylist.songList.length > 0" class="icon icon-play"></button>
                        <div>
                            <table>
                                <tr>
                                    <td>Playlist name:</td>
                                    <td><input ng-model="ctrl.form.managePlaylist.name" type="text" required /></td>
                                </tr>
                                <tr>
                                    <td>Creator:</td>
                                    <td><input ng-model="ctrl.form.managePlaylist.creator" type="text" required /></td>
                                </tr>
                            </table>
                        </div>

                        <h4>Songs</h4>

                        <div class="song-table">
                            <table>
                                <tr>
                                    <th style="width: 40%">Name</th>
                                    <th style="width: 20%">Singer</th>
                                    <th style="width: auto">Action</th>
                                </tr>
                                <tr ng-repeat="s in ctrl.form.managePlaylist.songList">
                                    <!-- <td>{{i + 1}}</td> -->
                                    <td>{{s.vname == "" ? s.name : s.vname}}</td>
                                    <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>
                                    <td>
                                        <div class="song-action">
                                            <button ng-click="ctrl.form.managePlaylist.remove(s)" class="icon icon-remove" title="Remove"></button>

                                            <button
                                                ng-click="ctrl.player.playHandler(s, ctrl.form.managePlaylist.songList)"
                                                ng-class="{
                                                    'icon icon-play': s.fileId != ctrl.player.songInfo.fileId || (s.fileId == ctrl.player.songInfo.fileId && ctrl.player.audio.paused),
                                                    'icon icon-pause': s.fileId == ctrl.player.songInfo.fileId && !ctrl.player.audio.paused
                                                }"
                                                title="Play"
                                            ></button>
                                            <button
                                                ng-click="ctrl.setSongFavorite(s)"
                                                ng-class="{
                                                    'icon icon-fav': !s.isFavorite && !s.isLoadingFav,
                                                    'icon icon-unfav': s.isFavorite && !s.isLoadingFav,
                                                    'icon icon-loading': s.isLoadingFav,
                                                }"
                                                title="Favorite"
                                            ></button>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <button ng-click="ctrl.form.managePlaylist.push()" class="btn btn-light">{{ctrl.form.managePlaylist.id ? 'Update' : 'Create'}}</button>
                    </div>

                    <div class="listPlaylist">
                        <table class="playlistTable">
                            <tr>
                                <th style="width: auto">Name</th>
                                <th style="width: 17%">Creator</th>
                                <th style="width: 5%">Count</th>
                                <th style="width: 24%">Action</th>
                            </tr>
                            <tr ng-repeat="p in ctrl.playlist">
                                <!-- <td>{{i + 1}}</td> -->
                                <td>{{p.name}}</td>
                                <td>{{p.creator}}</td>
                                <td>{{p.songList.length}}</td>
                                <td>
                                    <div class="song-action">
                                        <button ng-click="ctrl.playPlaylistHandler(p)" class="icon icon-play"></button>
                                        <button ng-click="ctrl.selectPlaylistBtnHandler(p)" class="icon icon-select"></button>
                                        <button ng-click="ctrl.removePlaylistBtnHandler(p)" class="icon icon-remove"></button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <style>
            #player-pro img {
                border-radius: 6px;
            }
        </style>
        <div id="player-pro" --n-g-if="ctrl.player._playlist.length > 0">
            <div class="container-fluid fixed-bottom px-2" style="background-color: #333; z-index: 1">
                <div class="row p-2">
                    <div class="col-sm-4">
                        <div class="">
                            <div class="d-flex align-items-center mx-1">
                                <div class="flex-shrink-0">
                                    <img ng-src="{{ ctrl.player.coverImgSrc ?  ctrl.player.coverImgSrc : ctrl.player.defaultCoverImgUrl }}" style="width: 60px; height: 60px" class="align-self-center mr-3" alt="..." />
                                </div>
                                <div class="ms-2 align-items-center">
                                    <div class="text-truncate fs-5" style="max-width: 450px" title="{{ctrl.player.songInfo.vname ? ctrl.player.songInfo.vname + ' - ' + ctrl.player.songInfo.name : ctrl.player.songInfo.name }}">{{ctrl.player.songInfo.vname ? ctrl.player.songInfo.vname + ' / ' + ctrl.player.songInfo.name : ctrl.player.songInfo.name}} <span class="badge fs-6">{{ctrl.player.currentExt.toUpperCase()}}</span></div>
                                    <div class="text-truncate fs-6 fst-normal" style="max-width: 450px" title="{{ctrl.player.songInfo.vsinger ? ctrl.player.songInfo.vsinger + ' - ' + ctrl.player.songInfo.singer: ctrl.player.songInfo.singer}}">{{ctrl.player.songInfo.vsinger ? ctrl.player.songInfo.vsinger + ' / ' + ctrl.player.songInfo.singer: ctrl.player.songInfo.singer}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                        .player-icon {
                            width: 25px;
                            height: 25px;
                            border-radius: 6px;
                            border: none;
                            cursor: pointer;
                            outline: none;
                            background-color: transparent;
                            transition: background-color 0.2s, transform 0.2s;
                            background-size: 80% 80%;
                            background-repeat: no-repeat;
                            background-position: center;
                            filter: invert(0.9) sepia(0.1) saturate(2) hue-rotate(180deg) brightness(1.2);
                        }

                        .player-icon:hover {
                            background-color: #1a73e863;
                            transform: scale(1.2);
                        }

                        .player-icon.i-selected {
                            background-color: #1a73e8;
                        }
                        .i-player-fullscreen {
                            background-image: url("https://www.svgrepo.com/download/238217/expand-fullscreen.svg");
                        }
                        .i-player-play {
                            background-image: url("https://www.svgrepo.com/download/521789/play.svg");
                        }

                        .i-player-pause {
                            background-image: url("https://www.svgrepo.com/download/521782/pause.svg");
                        }

                        .i-player-next {
                            background-image: url("https://www.svgrepo.com/download/521767/next.svg");
                        }

                        .i-player-prev {
                            background-image: url("https://www.svgrepo.com/download/521791/prev.svg");
                        }

                        .i-player-t-next {
                            background-image: url("https://www.svgrepo.com/download/522219/pauze.svg");
                        }

                        .i-player-t-prev {
                            background-image: url("https://www.svgrepo.com/download/522219/pauze.svg");
                        }

                        .i-player-loop-1 {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-repeat-once'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3' /%3E%3Cpath d='M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3' /%3E%3Cpath d='M11 11l1 -1v4' /%3E%3C/svg%3E");
                        }

                        .i-player-loop {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-repeat'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3' /%3E%3Cpath d='M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3' /%3E%3C/svg%3E");
                        }

                        .i-player-rand {
                            background-image: url("https://www.svgrepo.com/download/364830/shuffle-fill.svg");
                        }

                        .i-player-setting {
                            background-image: url("https://www.svgrepo.com/download/336109/setting-config.svg");
                        }

                        .i-player-speaker {
                            background-image: url("https://www.svgrepo.com/download/390429/audio-music-on-song-sound-speaker.svg");
                        }

                        .i-player-speaker-muted {
                            background-image: url("https://www.svgrepo.com/download/390443/audio-mic-microphone-music-off-sound.svg");
                        }

                        .i-player-playlist {
                            background-image: url("https://www.svgrepo.com/download/532701/list-music.svg");
                        }
                    </style>
                    <div class="col-sm-4 align-items-end pb-0">
                        <div class="play-icons text-white align-items-center d-flex justify-content-center">
                            <button
                                class="mx-2 my-1"
                                ng-class="{
                                    'player-icon i-player-rand i-selected ': ctrl.player.isRandomPlay,
                                    'player-icon i-player-rand': !ctrl.player.isRandomPlay,
                                }"
                                ng-click="ctrl.player.isRandomPlay = !ctrl.player.isRandomPlay"
                            ></button>
                            <button class="player-icon i-player-prev mx-2 my-1" ng-click="ctrl.player.prev()"></button>
                            <button
                                class="mx-2 my-1"
                                ng-class="{
                                    'player-icon i-player-play': !ctrl.player.isPlaying,
                                    'player-icon i-player-pause i-selected': ctrl.player.isPlaying
                                }"
                                ng-click="ctrl.player.playHandler()"
                            ></button>
                            <button class="player-icon i-player-next mx-2 my-1" ng-click="ctrl.player.next() "></button>
                            <button
                                class="mx-2 my-1"
                                ng-class="{
                                    'player-icon i-player-loop ': ctrl.player.loopMode == 0,
                                    'player-icon i-player-loop-1 i-selected': ctrl.player.loopMode == 1,
                                    'player-icon i-player-loop i-selected ': ctrl.player.loopMode == 2,
                                }"
                                ng-click="ctrl.player.loopMode = (ctrl.player.loopMode+1)%3"
                            ></button>
                        </div>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.current) }}</div>
                            <div class="mx-1" style="margin-top: -8px">
                                <input class="range" id="audioTimeRange" style="width: 25vw; height: 2px" type="range" step="0.3" min="0" max="{{ ctrl.player.in4.duration }}" aria-valuemin="0" aria-valuemax="{{ ctrl.player.in4.duration }}" aria-valuenow="{{ ctrl.player.in4.current }}" value="{{ ctrl.player.in4.current }}" />
                            </div>
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.duration) }}</div>
                        </div>
                        <!-- <div class="d-flex align-items-center justify-content-center">
                            <div class="" style="font-size: smaller">[No Lyrics]</div>
                        </div> -->
                    </div>
                    <div class="col-sm-4 text-white d-inline-flex flex-row-reverse align-items-center">
                        <div class="ml-2 mx-1"><button class="player-icon i-player-setting" id="settingBtn"></button></div>
                        <div class="ml-2 mx-1">
                            <button
                                ng-class="{
                                    'player-icon i-player-speaker': !ctrl.player.in4.volume.isMuted,
                                    'player-icon i-player-speaker-muted': ctrl.player.in4.volume.isMuted
                                }"
                                ng-click="ctrl.player.speakerBtnHandle()"
                                id="speakerBtn"
                            ></button>
                        </div>
                        <div class="ml-2 mx-1"><button id="playlistBtn" class="player-icon i-player-playlist"></button></div>
                        <div class="ml-2 mx-1"><button class="player-icon i-player-fullscreen" id="fullScreebBtn" ng-click="ctrl.player.showFc()"></button></div>
                    </div>
                </div>
            </div>
        </div>
        <style>
            /* Make the div take up 100% of the viewport width and height */
            #player-fc {
                width: 100vw;
                height: 100vh;
                padding: 2%;
                background-color: #008da3;
                color: white;
                font-size: 24px;
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000; /* Ensure it appears on top */
            }

            #player-fc img {
                border-radius: 16px;
                box-shadow: 5px 5px 5px 5px #45454563;
                border: 2px solid #45454563;
            }
            #player-fc .player-icon {
                transform: scale(1.5);
                padding: 10px;
            }
            #player-fc .i-player-playlist,
            #player-fc .i-player-speaker,
            #player-fc .i-player-speaker-muted,
            #player-fc .i-player-setting {
                transform: scale(1.2);
            }
        </style>
        <div id="player-fc">
            <div class="row w-100" style="height: 85%">
                <div class="col-sm-4 d-flex justify-content-end align-items-end p-4">
                    <div class="">
                        <img ng-src="{{ ctrl.player.coverImgSrc ?  ctrl.player.coverImgSrc : ctrl.player.defaultCoverImgUrl }}" style="width: 333px; height: 333px" />
                    </div>
                </div>
                <div class="col-sm-8 position-relative p-4">
                    <div class="row d-inline-flex justify-content-end w-100" style="height: 10%"><button class="icon icon-remove" ng-click="ctrl.player.hideFc()" title="Close"></button></div>
                    <div class="row h-65">
                        <div class="col-12" style="font-weight: normal">
                            <div class="row justify-content-center align-content-center pb-1 fs-3" id="lyric"></div>
                            <div class="row justify-content-center align-content-center pb-2 fs-4" id="supLyric"></div>
                            <div class="row justify-content-center align-content-center pb-2 fs-3" id="vnLyric"></div>
                            <div class="row justify-content-center align-content-center py-0 fs-3" id="enLyric"></div>
                        </div>
                    </div>
                    <div class="row h-auto position-absolute bottom-0 p-4">
                        <div class="" style="font-size: 35px">
                            {{ctrl.player.mainSongName}}
                            <!-- <span class="badge" style="color: #333; background-color: var(--line-color); filter: invert(0.9) sepia(0.1) saturate(2) hue-rotate(180deg) brightness(1.2)">{{ctrl.player.currentExt.toUpperCase()}}</span> -->
                        </div>
                        <div class="" style="font-size: 20px; font-weight: normal">{{ctrl.player.subSongName}}</div>
                    </div>
                </div>
            </div>
            <div class="row h-auto w-100">
                <div class="col-sm-12 align-items-end pb-0">
                    <div class="row w-100">
                        <div class="d-flex align-items-center justify-content-center fs-5">
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.current) }}</div>
                            <div class="range mx-1">
                                <input id="audioTimeRange-fc" style="width: 80vw; height: 4px" type="range" step="0.3" min="0" max="{{ ctrl.player.in4.duration }}" aria-valuemin="0" aria-valuemax="{{ ctrl.player.in4.duration }}" aria-valuenow="{{ ctrl.player.in4.current }}" value="{{ ctrl.player.in4.current }}" />
                            </div>
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.duration) }}</div>
                        </div>
                    </div>
                    <!-- <div class="d-flex align-items-center justify-content-center">
                        <div class="" style="font-size: smaller">[No Lyrics]</div>
                    </div> -->
                    <div class="row">
                        <div class="col-sm-4"></div>
                        <!-- control -->
                        <div class="col-sm-4 play-icons text-white align-items-center d-flex justify-content-center mt-4">
                            <button
                                class="mx-5 my-1"
                                ng-class="{
                        'player-icon i-player-rand i-selected ': ctrl.player.isRandomPlay,
                        'player-icon i-player-rand': !ctrl.player.isRandomPlay,
                    }"
                                ng-click="ctrl.player.isRandomPlay = !ctrl.player.isRandomPlay"
                            ></button>
                            <button class="player-icon i-player-prev mx-5 my-1" ng-click="ctrl.player.prev()"></button>
                            <button
                                class="mx-5 my-1"
                                ng-class="{
                        'player-icon i-player-play': !ctrl.player.isPlaying,
                        'player-icon i-player-pause i-selected': ctrl.player.isPlaying
                    }"
                                ng-click="ctrl.player.playHandler()"
                            ></button>
                            <button class="player-icon i-player-next mx-5 my-1" ng-click="ctrl.player.next() "></button>
                            <button
                                class="mx-5 my-1"
                                ng-class="{
                        'player-icon i-player-loop ': ctrl.player.loopMode == 0,
                        'player-icon i-player-loop-1 i-selected': ctrl.player.loopMode == 1,
                        'player-icon i-player-loop i-selected ': ctrl.player.loopMode == 2,
                    }"
                                ng-click="ctrl.player.loopMode = (ctrl.player.loopMode+1)%3"
                            ></button>
                        </div>
                        <!-- setting  -->
                        <div class="col-sm-4 play-icons text-white align-items-center d-flex justify-content-end mt-4">
                            <div class="ml-2 mx-3"><button class="player-icon i-player-setting" id="settingBtn-fc"></button></div>
                            <div class="ml-2 mx-3">
                                <button
                                    ng-class="{
                                'player-icon i-player-speaker': !ctrl.player.in4.volume.isMuted,
                                'player-icon i-player-speaker-muted': ctrl.player.in4.volume.isMuted
                            }"
                                    ng-click="ctrl.player.speakerBtnHandle()"
                                    id="speakerBtn-fc"
                                ></button>
                            </div>
                            <div class="ml-2 mx-3"><button id="playlistBtn-fc" class="player-icon i-player-playlist"></button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-none">
            <style>
                .propover-p {
                    font-size: small;
                }
                .propover-p .icon {
                    filter: unset;
                }
                .popover {
                    background-color: whitesmoke;
                    border: 1px solid var(--line-color);
                    border-radius: 10px;
                    max-width: 50%;
                }
                .propover-p th {
                    background-color: whitesmoke;
                }
            </style>
            <div class="propover-p" id="speakerPopover" ng-if="!ctrl.player.in4.volume.isMuted">
                <input type="range" step="1" min="0" max="100" ng-model="ctrl.player.in4.volume.value" ng-value="ctrl.player.in4.volume.value" />
            </div>
            <div id="settingPopover" class="w-75 propover-p">
                <table>
                    <tr>
                        <td>Speed</td>
                        <td>
                            <select ng-model="ctrl.player.in4.speed">
                                <option value="0.5">0.5</option>
                                <option value="0.75">0.75</option>
                                <option value="0.9">0.9</option>
                                <option value="1" selected>Normal</option>
                                <option value="1.1">1.1</option>
                                <option value="1.25">1.25</option>
                                <option value="1.5">1.5</option>
                                <option value="1.75">1.75</option>
                                <option value="2">2</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="playlistPopover" class="propover-p">
                <h3>Current Playlist</h3>

                <div class="song-table">
                    <table>
                        <tr>
                            <th style="max-width: 20%">Action</th>
                            <th style="max-width: 200px">Name</th>
                            <th style="max-width: 20%">Singer</th>
                        </tr>
                        <tr ng-repeat="s in ctrl.player.playlist">
                            <!-- <td>{{i + 1}}</td> -->
                            <td>
                                <div class="song-action">
                                    <button
                                        ng-click="ctrl.player.playHandler(s)"
                                        ng-class="{
                                            'icon icon-play': s.fileId != ctrl.player.songInfo.fileId || (s.fileId == ctrl.player.songInfo.fileId && ctrl.player.audio.paused),
                                            'icon icon-pause': s.fileId == ctrl.player.songInfo.fileId && !ctrl.player.audio.paused
                                        }"
                                        title="Play"
                                    ></button>
                                    <button
                                        ng-click="ctrl.setSongFavorite(s)"
                                        ng-class="{
                                            'icon icon-fav': !s.isFavorite && !s.isLoadingFav,
                                            'icon icon-unfav': s.isFavorite && !s.isLoadingFav,
                                            'icon icon-loading': s.isLoadingFav,
                                        }"
                                        title="Favorite"
                                    ></button>
                                </div>
                            </td>
                            <td>{{s.vname == "" ? s.name : s.vname}}</td>
                            <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script> -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js" integrity="sha512-YsR46MmyChktsyMMou+Bs74oCa/CDdwft7rJ5wlnmDzMj1mzqncsfJamEEf99Nk7IB0JpTMo5hS8rxB49FUktQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/pinyin@4.0.0-alpha.2/dist/pinyin.js"></script>
        <script>
            // var exports = {};
            document.addEventListener("DOMContentLoaded", function () {
                const spkPopover = configPopover("#speakerBtn", "#speakerPopover");
                const stgPopover = configPopover("#settingBtn", "#settingPopover");
                const playlistPropover = configPopover("#playlistBtn", "#playlistPopover", { trigger: "click hover" });
                const spkPopoverfc = configPopover("#speakerBtn-fc", "#speakerPopover");
                const stgPopoverfc = configPopover("#settingBtn-fc", "#settingPopover");
                const playlistPropoverfc = configPopover("#playlistBtn-fc", "#playlistPopover", { trigger: "click hover" });
            });

            function configPopover(btnSelector, contentSelector, opt = {}) {
                const content = document.querySelector(contentSelector);
                const btn = document.querySelector(btnSelector);
                const popover = new bootstrap.Popover(btn, {
                    trigger: opt["trigger"] ?? "manual",
                    html: true,
                    content: content,
                    placement: "top",
                    fallbackPlacements: [], // Disable automatic placement flipping
                });
                function isHovering(_e, pop_e) {
                    return _e.matches(":hover");
                }
                if (!opt["trigger"]) {
                    btn.addEventListener("mouseenter", function () {
                        setTimeout(function () {
                            if (isHovering(btn)) {
                                popover.show();
                            }
                        }, 200);
                    });

                    btn.addEventListener("mouseleave", function () {
                        setTimeout(function () {
                            if (!document.querySelector(contentSelector + ":hover") && !isHovering(btn)) {
                                popover.hide();
                            }
                        }, 400);
                    });
                    content.addEventListener("mouseleave", function () {
                        setTimeout(function () {
                            if (!document.querySelector(contentSelector + ":hover") && !isHovering(btn)) {
                                popover.hide();
                            }
                        }, 400);
                    });
                    return popover;
                }
            }
            class LyricLRC {
                constructor(lyricString) {
                    // console.log("updatelrc");
                    this.lyricsString = lyricString;
                    const lines = lyricString.split("\n");
                    const lineRegex = /\[(\d{1,2}):(\d{1,2})(?:\.(\d{2,3}))?\]\s?(.*)/;
                    const offsetRegex = /\[offset:(.*?)\]/;
                    this.lyrics = {
                        offset: 0,
                        data: [],
                    };

                    /// read LRC
                    for (const [i, line] of lines.entries()) {
                        let l;

                        if ((l = line.match(lineRegex))) {
                            this.lyrics.data.push({
                                startTime: parseInt(l[1]) * 60 + parseInt(l[2]) + parseFloat("0." + l[3]),
                                text: l[4].trim(),
                            });
                            continue;
                        }

                        if ((l = line.match(offsetRegex))) {
                            this.lyrics.offset = l[1] / 1000;
                            continue;
                        }
                    }

                    this.lyrics.data.map((lyric, i) => {
                        if (i < this.lyrics.data.length - 1) {
                            lyric.endTime = this.lyrics.data[i + 1].startTime;
                        } else {
                            lyric.endTime = 60 * 60;
                        }
                        return lyric;
                    });

                    this.getLyrics_nextIndex = 0;
                }

                getLyrics(timeAt) {
                    const { data, offset } = this.lyrics;
                    if (data.length == 0) {
                        return false;
                    }
                    timeAt = parseFloat(timeAt) + offset;

                    let lyric = data[this.getLyrics_nextIndex % data.length];

                    if (timeAt > lyric.startTime && timeAt < lyric.endTime) {
                        console.log(this.getLyrics_nextIndex, timeAt, lyric.startTime, lyric.text);
                        this.getLyrics_nextIndex++;
                        return lyric.text;
                    }

                    try {
                        const prevLyric = data[(this.getLyrics_nextIndex - 1) % data.length];
                        const nextLyric = data[(this.getLyrics_nextIndex + 1) % data.length];
                        if (timeAt < prevLyric.startTime || timeAt > nextLyric.endTime) {
                            let r = data.findIndex((l) => l.startTime < timeAt && l.endTime > timeAt);
                            if (r) {
                                this.getLyrics_nextIndex = r + 1;
                                return data[r].text;
                            }
                        }
                    } catch (e) {
                        // console.log(e);
                    }
                }
            }
        </script>
        <script>
            class MusicAppController {
                constructor($scope, $sce, $timeout, $http, DataService, AuthService) {
                    const ctrl = this;
                    this.$scope = $scope;
                    $scope.syncedLyricRegex = /^\[(syncType:LINE_SYNCED|src:)/;
                    this.$sce = $sce;
                    this.$timeout = $timeout;
                    this.$http = $http;
                    this.MSService = new MusicSourceService($http);
                    this.DataService = DataService;
                    this.AuthService = AuthService;

                    this.menu = document.getElementById("menu");
                    this.authToken = localStorage.getItem("authToken");
                    if (this.authToken != null && new Date().getTime() > this.authToken.split(":").pop()) {
                        localStorage.setItem("authToken", "");
                        this.authToken = "";
                    }
                    this.sortBy = "";
                    this.playlist = [];
                    // this.fileId = "<?= fileId?>";
                    this.sheet = "<?= sheet?>";
                    this.message = "";
                    this.keyList = [];
                    this.songList = undefined;
                    if (!isAppsScript) {
                        // test
                        this.songList = [
                            { name: "星星躲在云海", singer: "蓝心羽", fileId: "1lc54-cqJ7Wu-irOf3N648IuKuCtpc5fT", vname: "Những Ngôi Sao Ẩn TrBiểnBiểnBiểnBiểnBiểnBiểnBiểnBiểnong BiểnBiểnBiểnBiểnBiểnBiểnBiểnBiển Mây", vsinger: "Lam Tâm Vũ", isFavorite: true, listens: 0, sheet: "LanXinyu" },
                            { name: "寂寞背包", singer: "蓝心羽", fileId: "1upnBMaZeXGuuGNhNIkIIOCyFkiyEUIpa", vname: "?Ba lô cô đơn", vsinger: "Lam Tâm Vũ", isFavorite: false, listens: 0, sheet: "LanXinyu" },
                            { name: "荆棘里的歌", singer: "蓝心羽", fileId: "14NIlZMUSETlchQIJqZc6eXdErko-d2gk", vname: "?Bài hát trong Gai", vsinger: "Lam Tâm Vũ", isFavorite: false, listens: 0, sheet: "LanXinyu" },
                            { name: "贩卖日落", singer: "蓝心羽", fileId: "1u2uttC2IbqxKvxJycFybdASszapm0Z86", vname: "?Bán hoàng hôn", vsinger: "Lam Tâm Vũ", isFavorite: true, listens: 0, sheet: "LanXinyu" },
                            { name: "半茶", singer: "蓝心羽", fileId: "1oMW9vr26Rk_INobNZRKMFYJmg_tXYeBd", vname: "?Bán Trà", vsinger: "Lam Tâm Vũ", isFavorite: true, listens: 0, sheet: "LanXinyu" },
                            { name: "似有万语千言在耳边", singer: "蓝心羽", fileId: "1LCOhT5u6HK1a_nRUh-H6yPYfscSMToRK", vname: "?Dường như có hàng ngàn lời nói bên tai tôi", vsinger: "Lam Tâm Vũ", isFavorite: false, listens: 0, sheet: "LanXinyu" },
                            { name: "这一晚，列车开往银河", singer: "蓝心羽", fileId: "1J3U3JMyS6YR3KJZwr8Y29ky-qcGeC-_m", vname: "?Đêm đó, tàu khởi hành đi Dải Ngân Hà", vsinger: "Lam Tâm Vũ", isFavorite: false, listens: 0, sheet: "LanXinyu" },
                            { name: "来我身边", singer: "蓝心羽，KEYI", fileId: "1-t-YjL6JoAGF8Du4tfp44x2NGmb_0EXM", vname: "?Đến bên cạnh tôi", vsinger: "Lam Tâm Vũ, KEYI", isFavorite: false, listens: 0, sheet: "LanXinyu" },
                        ];
                    }

                    this.loadSongCategory();
                    this.loadAllDrvAK();
                    this.loadPlaylist();
                    if (this.sheet != "" && !this.sheet.startsWith("<") && !this.sheet.endsWith(">")) {
                        this.loadSongTable();
                    }
                    // music player controll
                    this.player = {
                        init: function ($scope) {
                            const player = this;
                            this.audioEvent();
                            $scope.secToMin = secToMin;

                            $scope.$watch(
                                function () {
                                    return player.in4.volume.value;
                                },
                                function (newValue, oldValue) {
                                    if (newValue !== oldValue) {
                                        player.setSpeakerValue(newValue);
                                    }
                                },
                            );
                            $scope.$watch(
                                function () {
                                    return player.in4.speed;
                                },
                                function (newValue, oldValue) {
                                    if (newValue !== oldValue) {
                                        player.audio.playbackRate = parseFloat(newValue);
                                    }
                                },
                            );
                            const audioTimeRange = document.querySelector("#audioTimeRange");
                            const audioTimeRangefc = document.querySelector("#audioTimeRange-fc");

                            audioTimeRange.addEventListener("change", (event) => {
                                console.log(player.in4.current, ">", event.target.value);
                                player.audio.currentTime = event.target.value;
                            });
                            audioTimeRangefc.addEventListener("change", (event) => {
                                console.log(player.in4.current, ">", event.target.value);
                                player.audio.currentTime = event.target.value;
                            });
                        },
                        in4: {
                            duration: "0",
                            current: "0",
                            volume: {
                                isMuted: false,
                                value: 75,
                            },
                            changeTime: 0,
                            speed: 1,
                        },
                        _playlist: [],
                        _favlist: [],
                        playlist: [],
                        prevPlaylist: [],
                        favlist: [],
                        // audio element
                        audio: new Audio(""),
                        setSpeakerValue: function (_val) {
                            if (_val > 0 || _val <= 100) {
                                this.audio.volume = _val / 100;
                            } else {
                                this.audio.volume = 0;
                            }
                        },
                        isPlaying: false,
                        audioEvent: function () {
                            this.setSpeakerValue(this.in4.volume.value);
                            const audio = this.audio;
                            let audioLog = {};
                            audio.addEventListener("timeupdate", () => {
                                this.in4.current = audio.currentTime;
                                this.updateLyric(this.in4.current);

                                if (this.in4.current > 0) {
                                    this.isPlaying = true;
                                }
                                // preparing next song
                                if (!this._cache._rnsWk && this.in4.current / audio.duration > 0.75) {
                                    // console.log("enter rdns");
                                    this._readyNextSong();
                                }

                                if (!audioLog.songInfo || audioLog.songInfo.fileId != this.songInfo.fileId) {
                                    audioLog = {
                                        songInfo: this.songInfo,
                                        count: 0,
                                        lastT: 0,
                                        done: false,
                                    };
                                } else {
                                    if (audioLog.songInfo && audioLog.songInfo.fileId == this.songInfo.fileId && audio.currentTime <= 1 && audioLog.lastT > audio.currentTime) {
                                        audioLog = {
                                            songInfo: this.songInfo,
                                            count: 0,
                                            lastT: 0,
                                            done: false,
                                        };
                                    }
                                }
                                audioLog.count += audio.currentTime - audioLog.lastT;
                                audioLog.lastT = audio.currentTime;
                                if (!audioLog.done && audio.duration / 2 < audioLog.count) {
                                    let s = audioLog.songInfo;
                                    ctrl.DataService.addListens(s).then((result) => {
                                        if (result.fileId) {
                                            ctrl.tryApply();
                                        }
                                    });
                                    this.songInfo.listens++;
                                    audioLog.done = true;
                                }
                                ctrl.tryApply();
                            });
                            audio.addEventListener("ended", () => {
                                this.next();
                                ctrl.tryApply();
                            });
                            audio.addEventListener("canplay", () => {
                                this.in4.duration = audio.duration;
                                this.fetchMetadata();
                                ctrl.tryApply();
                            });
                            audio.addEventListener("pause", () => {
                                this.isPlaying = false;
                                ctrl.tryApply();
                            });
                            // audio.addEventListener("loadedmetadata", function () {
                            //     ctrl.tryApply();
                            // });
                        },
                        // current song playing info
                        songInfo: undefined,
                        coverImgSrc: "",
                        currentExt: "",
                        defaultCoverImgUrl: "https://i.pinimg.com/736x/5a/e1/58/5ae15822d73ac828599044153fb91fed.jpg",
                        isRandomPlay: true,
                        loopMode: 0,
                        lyricLRCs: {
                            origin: undefined,
                            vs: undefined,
                            es: undefined,
                        },
                        isFavoriteList: false,
                        // set player song list
                        setPlaylist: function (songList) {
                            this._playlist = [...songList];
                            //set playlist
                            this.playlist = [...songList];
                            this.prevPlaylist = [];
                            this._favList = songList.filter((s) => s.isFavorite);
                            this.favList = [...this._favlist];
                            this.isOpen = true;
                            // this.audio.pause();
                        },
                        next: function () {
                            this._clearLyric();
                            if (this.playlist.length > 0) {
                                let rns = this._cache._rns;
                                if (rns.songInfo && this.isRandomPlay == rns.random && this.playlist.find((x) => x.fileId == rns.songInfo.fileId)) {
                                    this.refresh(rns.songInfo, rns.audio);
                                    return;
                                }

                                let songIn42Play;
                                if (this.isFavoriteList && this.playlist !== this.favlist) {
                                    this.favlist = [...this._favlist];
                                    this.playlist = this.favlist;
                                } else {
                                    if (this.playlist === this.favlist) {
                                        this.playlist = [...this._playlist];
                                    }
                                }
                                if (this.loopMode != 0 && this.songInfo) {
                                    this.audio.currentTime = 0;
                                    this.audio.play();
                                    if (this.loopMode == 1) {
                                        this.loopMode = 0;
                                    }
                                    return;
                                }
                                if (this.isRandomPlay) {
                                    songIn42Play = popRandomElement(this.playlist);
                                } else {
                                    songIn42Play = this.playlist.pop();
                                }
                                if (songIn42Play) {
                                    this.refresh(songIn42Play);
                                    this.prevPlaylist.push(songIn42Play);
                                }
                            }
                        },
                        prev() {
                            if (this.prevPlaylist.length > 0) {
                                this.refresh(this.prevPlaylist.pop());
                            }
                        },
                        _clearLyric() {
                            document.getElementById("lyric").innerText = "";
                            document.getElementById("supLyric").innerText = "";
                            document.getElementById("vnLyric").innerText = "";
                            document.getElementById("enLyric").innerText = "";
                        },
                        // play button handler
                        play(s) {
                            this.refresh(s);
                        },
                        restart() {
                            this.audio.currentTime = 0;
                            this.audio.play();
                        },
                        updateLyric(timeAt = 0) {
                            timeAt = parseFloat(timeAt) + 0.25;
                            const { origin, es, vs } = this.lyricLRCs;
                            try {
                                let sub;
                                if (origin && (sub = origin.getLyrics(timeAt))) {
                                    document.getElementById("lyric").innerText = sub;
                                    try {
                                        document.getElementById("supLyric").innerHTML = sub
                                            .split(".")
                                            .map((s) => {
                                                return s
                                                    .split(",")
                                                    .map((_s) => {
                                                        return pinyin
                                                            .pinyin(_s, {
                                                                segment: true, // 启用分词
                                                                group: true, // 启用词组
                                                            })
                                                            .map((p) => p[0])
                                                            .join(" ");
                                                    })
                                                    .join(", ")
                                                    .trim();
                                            })
                                            .join(". ")
                                            .trim();
                                    } catch (e) {
                                        console.log(e);
                                    }
                                }
                                if (vs && (sub = vs.getLyrics(timeAt))) {
                                    document.getElementById("vnLyric").innerText = sub;
                                }
                            } catch (e) {
                                // this._clearLyric
                                console.log("update lyric err", e);
                            }
                        },
                        // reset playlist
                        resetPlaylist() {
                            this.playlist = [...this._playlist];
                            this.favList = [...this._favlist];
                            this.prevPlaylist = [];
                        },
                        _cache: {
                            _rns: {},
                            _rnsWk: false,
                            clearRns() {
                                if (this._rns.url) {
                                    try {
                                        URL.revokeObjectURL(url);
                                        delete this._rns.audio;
                                        this._rns = {};
                                        this._rnsWk = false;
                                    } catch (e) {}
                                }
                            },
                        },
                        _readyNextSong() {
                            this._cache._rnsWk = true;
                            if (this.loopMode > 0) {
                                return;
                            }
                            if (this.playlist.length > 0) {
                                let songIn42Play;
                                if (this.isFavoriteList && this.playlist !== this.favlist) {
                                    this.favlist = [...this._favlist];
                                    this.playlist = this.favlist;
                                } else {
                                    if (this.playlist === this.favlist) {
                                        this.playlist = [...this._playlist];
                                    }
                                }
                                if (this.isRandomPlay) {
                                    songIn42Play = this.playlist[Math.floor(Math.random() * this.playlist.length)];
                                } else {
                                    songIn42Play = this.playlist[this.playlist.length - 1];
                                }
                                if (songIn42Play) {
                                    // console.log("ppfor ", songIn42Play);
                                    /// ready
                                    this._cache.clearRns();
                                    return (
                                        ctrl.MSService.getAudioSource(songIn42Play.fileId)
                                            // // let url = "https://www.googleapis.com/drive/v3/files/" + songIn42Play.fileId;
                                            // return fetch(url + "?alt=media&key=" + ctrl.selectKeyA_())
                                            //     .then((response) => response.blob())
                                            .then((blob) => {
                                                // console.log("rdn");
                                                let url = URL.createObjectURL(blob);
                                                let audio = new Audio(url);
                                                return (this._cache._rns = {
                                                    songInfo: songIn42Play,
                                                    audio: audio,
                                                    url: url,
                                                    blob: blob,
                                                    random: this.isRandomPlay,
                                                });
                                            })
                                            .catch((err) => {
                                                this._cache._rnsWk = false;
                                            })
                                    );
                                }
                            }
                        },

                        // set songinfo and play
                        refresh(songInfo, audio) {
                            if (ctrl.isReady()) {
                                this.songInfo = songInfo;
                                this.currentExt = "";
                                this.coverImgSrc = "";
                                this.in4.current = 0;
                                this.in4.duration = 0;
                                this.audio.pause();
                                this._clearLyric();
                                if (audio) {
                                    this.lyricLRCs = {
                                        origin: new LyricLRC(songInfo.lyric),
                                        vs: new LyricLRC(songInfo.lyric_vn),
                                        // es: new LyricLRC(song.songInfo.lyric_en),
                                    };
                                    this._cache._rnsWk = false;

                                    this.audio = audio;
                                    this.audio.title = this.mainSongName || this.subSongName;
                                    this.audioEvent();
                                    this.audio.load();
                                    this.audio.play();
                                } else {
                                    ctrl.MSService.getAudioSource(songInfo.fileId)
                                        // fetch(this.audioSrc)
                                        //     .then((response) => response.blob())
                                        .then((blob) => {
                                            this._cache.clearRns();
                                            let url = URL.createObjectURL(blob);
                                            let audio = new Audio(url);
                                            this._cache._rns = {
                                                // songInfo: songInfo,
                                                blob: blob,
                                                audio: audio,
                                                url: url,
                                            };
                                            this.refresh(songInfo, audio);
                                        });
                                }
                            }
                        },
                        playHandler(s, p) {
                            if (p) this.setPlaylist(p);
                            if (!s) {
                                if (this.songInfo) {
                                    if (this.audio.paused) {
                                        this.audio.play();
                                    } else {
                                        this.audio.pause();
                                    }
                                } else {
                                    this.next();
                                }
                            } else {
                                if (this.songInfo && s.fileId == this.songInfo.fileId) {
                                    if (this.audio.paused) {
                                        this.audio.play();
                                    } else {
                                        this.audio.pause();
                                    }
                                } else {
                                    this.play(s);
                                }
                                return;
                            }
                        },
                        speakerBtnHandle: function (value) {
                            this.in4.volume.isMuted = !this.in4.volume.isMuted;
                            if (!this.in4.volume.isMuted) {
                                this.in4.value = value;
                            }
                            ctrl.tryApply();
                        },
                        fetchMetadata: function () {
                            const player = this;

                            function processblob(blob) {
                                jsmediatags.read(blob, {
                                    onSuccess: function (tag) {
                                        player.currentExt = blob.type.split("/").pop();

                                        const tags = tag.tags;
                                        const picture = tags.picture;
                                        console.log(tags);
                                        if (picture) {
                                            player.coverImgSrc = "data:" + picture.format + ";base64," + arrayBufferToBase64(picture.data);
                                            ctrl.tryApply();
                                        } else {
                                        }
                                    },
                                    onError: function (error) {
                                        console.log("err: " + JSON.stringify(error));
                                    },
                                });
                            }
                            if (this._cache._rns.songInfo && this.songInfo.fileId == this._cache._rns.songInfo.fileId) {
                                return processblob(this._cache._rns.blob);
                            }

                            fetch(this._lastsrc, { headers: { Range: "bytes=0-2000000" } })
                                .then((response) => response.blob())
                                .then((blob) => {
                                    processblob(blob);
                                })
                                .catch((error) => {
                                    console.error("Error fetching the file:", error);
                                });
                        },
                        get mainSongName() {
                            try {
                                return this.songInfo.name == "" ? "" : `${this.songInfo.singer} - ${this.songInfo.name}`;
                            } catch (e) {
                                return "";
                            }
                        },
                        get subSongName() {
                            try {
                                return this.songInfo.vname == "" ? "" : `${this.songInfo.vsinger} - ${this.songInfo.vname}`;
                            } catch (e) {
                                return "";
                            }
                        },
                        _lastsrc: "",
                        get audioSrc() {
                            if (this.songInfo.fileId == "") return "";
                            return (this._lastsrc = "https://www.googleapis.com/drive/v3/files/" + this.songInfo.fileId + "?alt=media&key=" + ctrl.selectKeyA_());
                        },
                        // showAndroidNotification() {
                        // },
                        showFc() {
                            document.getElementById("player-fc").style.display = "block";
                        },
                        hideFc() {
                            document.getElementById("player-fc").style.display = "none";
                        },
                    };
                    this.player.init($scope);
                    const managePlaylist = {
                        isOpen: false,
                        id: undefined,
                        name: "",
                        creator: "guest",
                        songList: [],
                        remove: function (s) {
                            this.songList = this.songList.filter((x) => x.fileId != s.fileId);
                        },
                        add: function (s) {
                            this.songList.push(s);
                        },
                        addHandler: function (s) {
                            if (this.isAdded(s)) {
                                this.remove(s);
                            } else {
                                this.add(s);
                            }
                        },
                        getPlaylist() {
                            return {
                                id: this.id,
                                name: this.name,
                                creator: this.creator,
                                songList: this.songList,
                            };
                        },
                        push: function () {
                            let pl = this.getPlaylist();
                            if (this.id == undefined) {
                                console.log("add");

                                return ctrl.DataService.addPlaylist(pl).then((result) => {
                                    if (result) {
                                        ctrl.playlist.push(result);
                                        ctrl.tryApply();
                                        alert("add ok" + result);
                                    } else {
                                        alert("add err" + result);
                                    }
                                });
                            } else {
                                return ctrl.DataService.updatePlaylist(pl).then((result) => {
                                    if (result) {
                                        ctrl.playlist = ctrl.playlist.map((x) => {
                                            copyObj(x, pl);
                                        });
                                        ctrl.tryApply();
                                        alert("update ok");
                                    } else {
                                        alert("Update error \n " + result);
                                    }
                                });
                            }
                        },
                        isAdded(s) {
                            if (this.songList.find((m) => m.fileId == s.fileId)) {
                                return true;
                            } else return false;
                        },
                        setPlaylist: function (_playlist) {
                            this.id = _playlist.id;
                            this.name = _playlist.name;
                            this.songList = angular.copy(_playlist.songList);
                            this.creator = _playlist.creator;
                            this.isOpen = true;
                        },
                        default: function () {
                            this.id = undefined;
                            this.name = "";
                            this.songList = [];
                            this.creator = "guest";
                        },
                    };
                    const manageSong = {
                        _songInfo: {},
                        songInfo: {},
                        init(songInfo) {
                            this._songInfo = songInfo;
                            copyObj(this.songInfo, songInfo);
                            return this;
                        },
                        update() {
                            let _si = this._songInfo;
                            ctrl.DataService.updateSong(this.songInfo).then((result) => {
                                if (result) {
                                    alert("update ok ");
                                    moveObj(_si, result);
                                    if (result.fileId == this.songInfo.fileId) {
                                        copyObj(this.songInfo, result);
                                    }
                                    ctrl.tryApply();
                                } else {
                                    alert("update err " + result);
                                }
                            });
                        },
                        show() {
                            $("#manageSongForm").modal("show");
                            $(".modal-backdrop").appendTo(".container.selfcontainer");
                            $(".modal-backdrop").width("90vw");
                            $("body").removeClass();
                            $("div.modal-backdrop.fade.show").hide();
                        },
                    };
                    this.form = {
                        managePlaylist: managePlaylist,
                        manageSong: manageSong,
                    };
                    $scope.$watch(
                        function () {
                            return ctrl.searchValue;
                        },
                        function (newValue, oldValue) {
                            if (newValue !== oldValue) {
                                ctrl.songList = ctrl._songList.filter((s) => {
                                    for (const key of newValue.toLowerCase().split(" ")) {
                                        if (!removeVietnameseTones(`${s.vsinger} - ${s.vname} |  ${s.singer} - ${s.name}`).toLowerCase().includes(key)) {
                                            return false;
                                        }
                                    }
                                    return true;
                                });
                            }
                        },
                    );
                    $scope.$watch(
                        function () {
                            return localStorage.getItem("authKey");
                        },
                        function (newValue, oldValue) {
                            if (newValue !== oldValue && newValue == "") {
                                ctrl.authToken = "";
                            }
                        },
                    );
                    $scope.$watch(
                        function () {
                            return ctrl.sortBy;
                        },
                        function (newValue, oldValue) {
                            if (newValue !== oldValue) {
                                console.log(newValue, oldValue);

                                switch (newValue) {
                                    case "name-asc":
                                        ctrl.songList.sort((a, b) => compareObj(a, b, "name"));
                                        break;
                                    case "name-desc":
                                        ctrl.songList.sort((a, b) => compareObj(b, a, "name"));
                                        break;
                                    case "singer-asc":
                                        ctrl.songList.sort((a, b) => compareObj(a, b, "singer"));
                                        break;
                                    case "singer-desc":
                                        ctrl.songList.sort((a, b) => compareObj(b, a, "singer"));
                                        break;
                                    case "listens-asc":
                                        ctrl.songList.sort((a, b) => compareObj(a, b, "listens"));
                                        break;
                                    case "listens-desc":
                                        ctrl.songList.sort((a, b) => compareObj(b, a, "listens"));
                                        break;
                                    // case "":
                                    //     ctrl.songList = [...ctrl._songList];
                                    default:
                                        break;
                                }
                            }
                        },
                    );
                }
                isReady() {
                    if (this.keyList.length > 0) {
                        return true;
                    }
                    return false;
                }
                tryApply() {
                    try {
                        this.$scope.$apply();
                    } catch (e) {
                        // console.log("apply err " + e);
                    }
                }
                loadPlaylist() {
                    this.DataService.getAllPlaylist().then((result) => {
                        if (result) {
                            this.playlist = result;
                            this.tryApply();
                        }
                    });
                }
                loadSongCategory() {
                    this.DataService.getAllCategory().then((result) => {
                        this.sheetNames = result;
                        this.tryApply();
                    });
                }
                loadSongTable() {
                    this.songList = undefined;
                    this.menu.hidden = true;
                    this.message = `Loading song list of '${this.sheet}'`;
                    document.body.style.cursor = "wait";
                    this.sortBy = "";
                    let __w = this.sheet;
                    this.DataService.getSongsByCategory(__w).then((result) => {
                        this.message = ``;
                        if (__w == this.sheet) {
                            this._songList = [...result];
                            this.songList = [...result];
                            // this.player.setPlaylist(result);
                            this.tryApply();
                            document.body.style.cursor = "default";
                        }
                    });
                }
                loadAllDrvAK() {
                    this.DataService.getAllKeys().then((result) => {
                        this.keyList = result;
                        this.MSService.keyList = result;
                    });
                }
                getButtonLabel(name) {
                    if (name == this.sheet) {
                        return this.$sce.trustAsHtml("<u>" + name + "</u>"); // Use trusted HTML for rendering
                    } else {
                        return this.$sce.trustAsHtml(name);
                    }
                }
                selectSheetBtnHandler(name) {
                    this.sheet = name;
                    this.loadSongTable();
                }
                playSongList() {
                    this.player.setPlaylist([...this.songList]);
                    this.player.next();
                }
                playPlaylistHandler(p) {
                    this.form.managePlaylist.setPlaylist(p);
                    this.player.setPlaylist([...p.songList]);
                    this.player.next();
                }
                removePlaylistBtnHandler(pl) {
                    if (localStorage.getItem("authToken") == null || localStorage.getItem("authToken") == "") {
                        return alert("Not authorized");
                    }
                    const ctrl = this;
                    if (confirm("Confirm delete playlist " + pl.name + " of " + pl.creator)) {
                        this.DataService.removePlaylist(pl).then((result) => {
                            this.playlist.filter((x) => x.id != pl.id);
                            this.tryApply();
                            alert("remove ok");
                        });
                    }
                }
                showCreatePlaylistForm() {
                    this.form.managePlaylist.isOpen = !this.form.managePlaylist.isOpen;
                    this.form.managePlaylist.default();
                }
                selectPlaylistBtnHandler(p) {
                    this.form.managePlaylist.setPlaylist(p);
                }
                setSongFavorite(song) {
                    if (localStorage.getItem("authToken") == null || localStorage.getItem("authToken") == "") {
                        return alert("Not authorized");
                    }
                    if (song.fileId.length == 33) {
                        song.isLoadingFav = true;
                        this.DataService.setFavoriteSong(song)
                            .then((result) => {
                                if (result) {
                                    song.isFavorite = !song.isFavorite;
                                    if (song.fileId == this.player.songInfo.fileId) {
                                        this.player.songInfo = song;
                                    }
                                } else {
                                    alert("setSongFavorite err: unknown " + ": got result= \n" + result);
                                }
                                song.isLoadingFav = false;
                                this.tryApply();
                            })
                            .catch((err) => {
                                song.isLoadingFav = false;
                                this.tryApply();
                                alert(err);
                            });
                    }
                }
                homeSelectCategoryHandler(name) {
                    this.selectSheetBtnHandler(name);
                }
                selectKeyA_() {
                    if (this.keyList) {
                        this.selectKeyA_.lastKeyIdx = ((this.selectKeyA_.lastAudioIndex ?? -1) + 1) % this.keyList.length;
                        return this.keyList[this.selectKeyA_.lastKeyIdx];
                    }
                }
                enableUpdateBtnHandler() {
                    let __key = prompt("enter Keys");
                    if (__key) {
                        let token = this.AuthService.auth({ username: "admin", password: __key }).then((result) => {
                            if (result) {
                                localStorage.setItem("authToken", result.authToken);
                                this.authToken = result.authToken;
                                alert("enabled update");
                                this.tryApply();
                            } else {
                                alert("err keys");
                            }
                        });
                    }
                }
            }
            class _Service {
                constructor($http) {
                    this.$http = $http;
                    this.rpcServer = "https://script.google.com/macros/s/AKfycbz1FHLLdtpW5hba-4NlD0l-tqqBpdZ4EbvYuRAC2GfTU5g_RR6pHgti3trJ0nWkwoVOFA/exec";
                }
                static getAuthToken() {
                    let token = localStorage.getItem("authToken");
                    if (token == null || token == "") return "";
                    if (new Date().getTime() > token.split(":").pop()) {
                        localStorage.setItem("authToken", "");
                        return "";
                    }
                    return token;
                }
                query(methodName, params) {
                    if (isAppsScript) {
                        return appsScriptRunAsync("simulateJSONRpcCall", [methodName, params, _Service.getAuthToken()])
                            .then((res) => {
                                if ("result" in res) {
                                    return res.result;
                                }
                                if ("error" in res) {
                                    console.log("jsonrpc err" + JSON.stringify(res.err));
                                    throw new Error("ServerError\n" + JSON.stringify(res.err));
                                }
                            })
                            .catch((err) => {
                                console.log(err, methodName);
                                throw new Error(JSON.stringify(err));
                            });
                    } else {
                        return (
                            this.$http
                                .post(this.rpcServer, {
                                    jsonrpc: "2.0",
                                    method: methodName,
                                    params: params,
                                    authToken: _Service.getAuthToken(),
                                })
                                .then((response) => response.data)
                                // return fetch(this.rpcServer, {
                                //     method: "POST",
                                //     redirect: "follow",
                                //     body: {
                                //         jsonrpc: "2.0",
                                //         method: methodName,
                                //         params: params,
                                //         authToken: _Service.getAuthToken(),
                                //     },
                                // })
                                .then((response) => response.json())
                                .then((data) => {
                                    // console.log(data);
                                    if ("result" in data) {
                                        return data.result;
                                    }
                                    if ("error" in data) {
                                        console.log("jsonrpc err" + data.error);
                                        throw new Error("jsonrpc err" + res.error);
                                    }
                                })
                                .catch((err) => {
                                    console.log("post err" + err);
                                    throw new Error("err :" + methodName + " " + err);
                                })
                        );
                    }
                }
            }
            class AuthService extends _Service {
                constructor($http) {
                    super($http);
                }
                auth({ username, password }) {
                    return this.query("auth", [{ username, password }]);
                }
            }
            class DataService extends _Service {
                constructor($http) {
                    super($http);
                }
                getSongsByCategory(categoryName) {
                    return this.query("getAllSongAndId", [categoryName]);
                }
                getAllCategory() {
                    return this.query("getAllSheetName", []);
                }
                getAllKeys(param) {
                    return this.query("getAllApiKey", []);
                }
                // @_Service.requireAuthToken
                setFavoriteSong(song) {
                    return this.query("setSongFavorite", [song.sheet, song.fileId, !song.isFavorite]);
                }
                // @_Service.requireAuthToken
                updateSong(s) {
                    return this.query("updateSong", [s]);
                }
                getAllPlaylist() {
                    return this.query("getAllPlaylist", []);
                }
                addPlaylist(playlist) {
                    if (!isNaN(parseInt(playlist.id))) {
                        throw Error("add err: got " + playlist);
                    }
                    return this.query("addPlaylist", [playlist]);
                }
                // @_Service.requireAuthToken
                removePlaylist(playlist) {
                    return this.query("removePlaylist", [playlist]);
                }
                // @_Service.requireAuthToken
                updatePlaylist(playlist) {
                    if (isNaN(parseInt(playlist.id))) {
                        throw Error("update err: got " + playlist);
                    }
                    return this.query("updatePlaylist", [playlist]);
                }
                addListens(songInfo) {
                    return this.query("addListens", [songInfo]);
                }
            }
            class MusicSourceService extends _Service {
                constructor($http, keyList = []) {
                    super($http);
                    this.keyList = keyList;
                }

                getAudioSource(fileId) {
                    if (true) {
                        // if (isAppsScript) {
                        return fetch("https://www.googleapis.com/drive/v3/files/" + fileId + "?alt=media&key=" + this.selectKeyA_()).then((response) => response.blob());
                    } else {
                        return this.query("getAudio", [fileId]).then((result) => {
                            if (result) {
                                return base64ToBlob(result);
                            }
                        });
                    }
                }
                selectKeyA_() {
                    if (this.keyList) {
                        this.selectKeyA_.lastKeyIdx = ((this.selectKeyA_.lastAudioIndex ?? -1) + 1) % this.keyList.length;
                        return this.keyList[this.selectKeyA_.lastKeyIdx];
                    }
                }
            }

            var app = angular.module("musicApp", ["ngSanitize"]);
            app.service("DataService", ["$http", DataService]);
            app.service("AuthService", ["$http", AuthService]);
            app.controller("MusicAppController", ["$scope", "$sce", "$timeout", "$http", "DataService", "AuthService", MusicAppController]);
        </script>
        <script>
            // utils
            function popRandomElement(arr) {
                if (arr.length === 0) return undefined;
                const randomIndex = Math.floor(Math.random() * arr.length);
                const [removedElement] = arr.splice(randomIndex, 1);
                return removedElement;
            }
            function arrayBufferToBase64(buffer) {
                let binary = "";
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
            function removeVietnameseTones(str) {
                str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                str = str.replace(/đ/g, "d").replace(/Đ/g, "D");
                return str;
            }
            function compareObj(a, b, p) {
                try {
                    if (a[p] > b[p]) return 1;
                    if (a[p] < b[p]) return -1;
                } catch (e) {}
                return 0;
            }
            function copyObj(a, b) {
                for (const [k, v] of Object.entries(b)) {
                    a[k] = v;
                }
                return a;
            }
            function moveObj(a, b) {
                for (const [k, v] of Object.entries(b)) {
                    if (!k.includes("$")) {
                        a[k] = v;
                    }
                }
                return a;
            }
            function secToMin(seconds) {
                seconds = parseInt(seconds);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${String(minutes).padStart(2, "0")}:${String(remainingSeconds).padStart(2, "0")}`;
            }
            function base64ToBlob(base64String, contentType = "") {
                let base64Data = base64String;
                if (base64String.includes(",")) {
                    const parts = base64String.split(",");
                    const mimeMatch = parts[0].match(/:(.*?);/);
                    contentType = mimeMatch ? mimeMatch[1] : "application/octet-stream";
                    base64Data = parts[1];
                }
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: contentType });
            }
        </script>
    </body>
</html>
