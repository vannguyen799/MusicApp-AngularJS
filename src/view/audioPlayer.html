<!DOCTYPE html>
<html lang="en" ng-app="musicApp">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            :root {
                --bg-color: rgb(37, 39, 40);
                --txt-color: rgb(212, 212, 212);
                --header-h: 40px;
                --line-color: #1a73e8;
            }
            /* Full-page overlay for the loader */
            #loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: var(--bg-color); /* Dark background */
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* Hide the loader when Angular is fully ready */
            body.loaded #loading-overlay {
                display: none;
            }

            body,
            html {
                font-family: Open Sans, sans-serif;
                font-size: small;
                font-weight: 500;
                margin: 0;
                padding: 0;
                height: 100%;
                color: var(--txt-color);
                background-color: var(--bg-color);
                overflow: hidden;
            }
            .text-truncate {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 200px;
            }
            th,
            td {
                border-bottom: 1px solid rgba(231, 231, 231, 0.504);
                padding: 8px;
                width: auto;
                text-align: left;
            }
            .header {
                position: sticky;
                top: 0;
                z-index: 1000;
                width: 100%;
                text-align: center;
                align-items: center;
                background-color: #333;
                height: var(--header-h);
            }
            .playlist-container {
                flex: 1;
                width: 100%;
                padding-top: 10px;
                padding-left: 20px;
                right: 0;
                overflow-x: hidden;
                overflow-y: auto;
                max-height: 82vh;
            }
            .playlist-container::-webkit-scrollbar {
                width: 0;
                /* Ẩn thanh cuộn ngang */
                height: 0;
                /* Ẩn thanh cuộn dọc */
            }
            .playlist-container::-webkit-scrollbar-thumb {
                background: transparent;
                /* Ẩn phần tay cầm của thanh cuộn */
            }
            .playlist-container::-webkit-scrollbar-track {
                background: transparent;
                /* Ẩn phần nền của thanh cuộn */
            }
            .playlist-top {
                position: sticky;
                top: 0;
                /* Định vị tiêu đề bảng cố định khi cuộn */
                z-index: 1;
                /* Đảm bảo tiêu đề nằm trên nội dung */
                fill: inherit;
            }
            .song-table {
                overflow-x: hidden;
                overflow-y: auto;
                max-height: 300px;
            }
            .song-table::-webkit-scrollbar {
                width: 10px;
                /* Chiều rộng thanh cuộn */
            }
            .song-table::-webkit-scrollbar-track {
                background-color: #909090;
                /* Màu nền của track thanh cuộn */
                border-radius: 10px;
                /* Bo góc track thanh cuộn */
            }
            .song-table::-webkit-scrollbar-thumb {
                background-color: #464646;
                /* Màu của thanh cuộn */
                border-radius: 10px;
                /* Bo góc thanh cuộn */
            }
            /* .song-table::-webkit-scrollbar-thumb:hover {
                background-color: #a0a0a0; 
            } */
            .song-table th {
                position: sticky;
                top: 0;
                z-index: 2;
                fill: inherit;
                background-color: var(--bg-color);
            }
            .song-table tr:hover {
                background-color: #90909040;
            }
            .managePlaylistForm {
                border: 1px solid #444444;
                padding: 10px;
            }
            .managePlaylistForm > div {
                margin: 7px;
            }
            .table-action {
                margin: 5px;
                width: 100%;
                display: flex;
            }
            .table-action * {
                margin-right: 20px;
            }
            .table-action select {
                justify-self: end;
                margin-left: auto;
            }
        </style>
        <style>
            .footer > button {
                z-index: 11000;
                position: fixed;
                right: 1%;
                left: auto;
                bottom: 3%;
            }
        </style>
        <style>
            /* Base styles for all icons */
            .icon {
                width: 23px;
                height: 23px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                outline: none;
                background-color: transparent;
                transition: background-color 0.2s, transform 0.2s;
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                filter: invert(0.9) sepia(0.1) saturate(2) hue-rotate(180deg) brightness(1.2);
            }

            .btn-icon {
                cursor: pointer;
                outline: none;
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                color: var();
            }
            /* Individual icons */
            .icon-play {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' fill='%23000000' height='800px' width='800px' version='1.1' id='Layer_1' viewBox='0 0 512 512' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cpath d='M256,0C114.51,0,0,114.497,0,256c0,141.49,114.495,256,256,256c141.491,0,256-114.497,256-256 C512,114.509,397.503,0,256,0z M256,478.609c-122.746,0-222.609-99.862-222.609-222.609S133.252,33.391,256,33.391 S478.609,133.254,478.609,256S378.746,478.609,256,478.609z'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cg%3E%3Cpath d='M358.185,241.544l-155.778-90.01c-11.128-6.426-25.048,1.63-25.048,14.456V346.01c0,12.922,14.01,20.833,25.048,14.456 l155.778-90.01C369.301,264.032,369.287,247.96,358.185,241.544z M210.75,317.081V194.919L316.461,256L210.75,317.081z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-pause {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' fill='%23000000' height='800px' width='800px' version='1.1' id='Layer_1' viewBox='0 0 511.999 511.999' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cpath d='M256.001,0C114.509,0,0,114.497,0,255.999C0,397.49,114.497,511.999,255.999,511.999 c141.492,0,255.999-114.496,255.999-255.999C512,114.511,397.503,0,256.001,0z M256.001,478.252 c-122.55,0-222.252-99.702-222.252-222.252S133.451,33.748,256.001,33.748s222.251,99.701,222.251,222.251 S378.55,478.252,256.001,478.252z'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cg%3E%3Cpath d='M197.58,138.901c-26.221,0-47.554,21.332-47.554,47.554v139.09c0,26.221,21.332,47.553,47.554,47.553 s47.553-21.332,47.553-47.553V186.456C245.134,160.234,223.801,138.901,197.58,138.901z M211.385,325.546 c0,7.612-6.193,13.805-13.805,13.805s-13.805-6.193-13.805-13.805v-139.09c0-7.612,6.193-13.805,13.805-13.805 s13.805,6.193,13.805,13.805V325.546z'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cg%3E%3Cpath d='M314.42,138.901c-26.222,0-47.554,21.332-47.554,47.554v139.09c0,26.221,21.332,47.553,47.554,47.553 s47.554-21.332,47.554-47.553V186.456C361.973,160.234,340.641,138.901,314.42,138.901z M328.225,325.546 c0,7.612-6.194,13.805-13.805,13.805s-13.805-6.193-13.805-13.805v-139.09c0-7.612,6.194-13.805,13.805-13.805 s13.805,6.193,13.805,13.805V325.546z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-fav {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' version='1.2' viewBox='0 0 24 24' width='800' height='800'%3E%3Ctitle%3Estar-circle-svgrepo-com (1)-svg%3C/title%3E%3Cstyle%3E .s0 %7B fill: %23000000;stroke: %23000000;stroke-width: .4 %7D %3C/style%3E%3Cg id='SVGRepo_bgCarrier'%3E%3C/g%3E%3Cg id='SVGRepo_tracerCarrier'%3E%3C/g%3E%3Cg id='SVGRepo_iconCarrier'%3E%3Cpath fill-rule='evenodd' class='s0' d='m16.5 1.1c1.4 0.6 2.7 1.5 3.8 2.6 1.1 1.1 2 2.4 2.6 3.8 0.6 1.4 0.9 3 0.9 4.5 0 4.8-2.9 9-7.3 10.9-4.4 1.8-9.5 0.8-12.8-2.6-3.4-3.3-4.4-8.4-2.6-12.8 1.9-4.4 6.1-7.3 10.9-7.3 1.5 0 3.1 0.3 4.5 0.9zm-0.4 20.7c1.2-0.5 2.4-1.3 3.4-2.3 1-1 1.8-2.2 2.3-3.4 0.5-1.3 0.8-2.7 0.8-4.1 0-4.3-2.6-8.2-6.5-9.8-4-1.7-8.6-0.7-11.6 2.3-3 3-4 7.6-2.3 11.6 1.6 3.9 5.5 6.5 9.8 6.5 1.4 0 2.8-0.3 4.1-0.8zm2.5-11.9q0.1 0.1 0.2 0.3 0.1 0.3 0 0.5-0.1 0.2-0.2 0.3l-3.1 2.6 1 3.9q0 0.1 0 0.2 0 0.1 0 0.2-0.1 0.1-0.1 0.2-0.1 0.1-0.2 0.2 0 0-0.1 0 0 0.1-0.1 0.1 0 0-0.1 0 0 0-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0l-3.4-2.1-3.4 2.1q-0.2 0.1-0.5 0.1-0.2 0-0.4-0.1-0.1-0.2-0.2-0.4-0.1-0.2 0-0.4l0.9-3.9-3-2.6q-0.2-0.1-0.3-0.3 0-0.2 0-0.5 0.1-0.2 0.3-0.3 0.2-0.1 0.4-0.1l4-0.4 1.5-3.7q0.1-0.2 0.3-0.3 0.2-0.1 0.4-0.1 0.2 0 0.4 0.1 0.2 0.1 0.2 0.3l1.6 3.7 3.9 0.4q0.3 0 0.5 0.1zm-1.6 0.9l-3.6-0.3-1.4-3.4-1.5 3.4-3.6 0.3 2.8 2.4-0.9 3.6 3.2-1.9 3.1 1.9-0.8-3.6z'/%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-loading {
                background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Ccircle fill='%2523000000' stroke='%2523000000' stroke-width='15' r='15' cx='40' cy='65'%3E%3Canimate attributeName='cy' calcMode='spline' dur='2' values='65;135;65;' keySplines='.5 0 .5 1;.5 0 .5 1' repeatCount='indefinite' begin='-.4'%3E%3C/animate%3E%3C/circle%3E%3Ccircle fill='%2523000000' stroke='%2523000000' stroke-width='15' r='15' cx='100' cy='65'%3E%3Canimate attributeName='cy' calcMode='spline' dur='2' values='65;135;65;' keySplines='.5 0 .5 1;.5 0 .5 1' repeatCount='indefinite' begin='-.2'%3E%3C/animate%3E%3C/circle%3E%3Ccircle fill='%2523000000' stroke='%2523000000' stroke-width='15' r='15' cx='160' cy='65'%3E%3Canimate attributeName='cy' calcMode='spline' dur='2' values='65;135;65;' keySplines='.5 0 .5 1;.5 0 .5 1' repeatCount='indefinite' begin='0'%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E%0A");
            }

            .icon-unfav {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' version='1.2' viewBox='0 0 56 56' width='800' height='800'%3E%3Ctitle%3Estar-circle-fill-svg%3C/title%3E%3Cstyle%3E .s0 %7B fill: %23000000 %7D %3C/style%3E%3Cpath fill-rule='evenodd' class='s0' d='m28 56c-15.5 0-28-12.5-28-28 0-15.5 12.5-28 28-28 15.5 0 28 12.5 28 28 0 15.5-12.5 28-28 28zm-8.5-13.1l8.5-6.2 8.5 6.2c1 0.7 1.8 0.9 2.5 0.4q0.9-0.7 0.3-2.4l-3.3-10 8.6-6.2c0.9-0.7 1.3-1.4 1.1-2.2q-0.4-1.1-2.2-1.1l-10.6 0.1-3.2-10.1c-0.3-1.1-0.9-1.7-1.7-1.7-0.8 0-1.4 0.6-1.7 1.7l-3.2 10.1-10.6-0.1c-1.2 0-1.9 0.4-2.2 1.1-0.2 0.8 0.2 1.5 1.1 2.2l8.6 6.2-3.3 10q-0.6 1.7 0.3 2.4c0.7 0.5 1.5 0.3 2.5-0.4z'/%3E%3C/svg%3E");
            }

            .icon-add {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:sketch='http://www.bohemiancoding.com/sketch/ns' width='800px' height='800px' viewBox='0 0 32 32' version='1.1'%3E%3Ctitle%3Eplus-circle%3C/title%3E%3Cdesc%3ECreated with Sketch Beta.%3C/desc%3E%3Cdefs%3E%3C/defs%3E%3Cg id='Page-1' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' sketch:type='MSPage'%3E%3Cg id='Icon-Set' sketch:type='MSLayerGroup' transform='translate(-464.000000, -1087.000000)' fill='%23000000'%3E%3Cpath d='M480,1117 C472.268,1117 466,1110.73 466,1103 C466,1095.27 472.268,1089 480,1089 C487.732,1089 494,1095.27 494,1103 C494,1110.73 487.732,1117 480,1117 L480,1117 Z M480,1087 C471.163,1087 464,1094.16 464,1103 C464,1111.84 471.163,1119 480,1119 C488.837,1119 496,1111.84 496,1103 C496,1094.16 488.837,1087 480,1087 L480,1087 Z M486,1102 L481,1102 L481,1097 C481,1096.45 480.553,1096 480,1096 C479.447,1096 479,1096.45 479,1097 L479,1102 L474,1102 C473.447,1102 473,1102.45 473,1103 C473,1103.55 473.447,1104 474,1104 L479,1104 L479,1109 C479,1109.55 479.447,1110 480,1110 C480.553,1110 481,1109.55 481,1109 L481,1104 L486,1104 C486.553,1104 487,1103.55 487,1103 C487,1102.45 486.553,1102 486,1102 L486,1102 Z' id='plus-circle' sketch:type='MSShapeGroup'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-remove {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:sketch='http://www.bohemiancoding.com/sketch/ns' width='800px' height='800px' viewBox='0 0 32 32' version='1.1'%3E%3Ctitle%3Ecross-circle%3C/title%3E%3Cdesc%3ECreated with Sketch Beta.%3C/desc%3E%3Cdefs%3E%3C/defs%3E%3Cg id='Page-1' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' sketch:type='MSPage'%3E%3Cg id='Icon-Set-Filled' sketch:type='MSLayerGroup' transform='translate(-570.000000, -1089.000000)' fill='%23000000'%3E%3Cpath d='M591.657,1109.24 C592.048,1109.63 592.048,1110.27 591.657,1110.66 C591.267,1111.05 590.633,1111.05 590.242,1110.66 L586.006,1106.42 L581.74,1110.69 C581.346,1111.08 580.708,1111.08 580.314,1110.69 C579.921,1110.29 579.921,1109.65 580.314,1109.26 L584.58,1104.99 L580.344,1100.76 C579.953,1100.37 579.953,1099.73 580.344,1099.34 C580.733,1098.95 581.367,1098.95 581.758,1099.34 L585.994,1103.58 L590.292,1099.28 C590.686,1098.89 591.323,1098.89 591.717,1099.28 C592.11,1099.68 592.11,1100.31 591.717,1100.71 L587.42,1105.01 L591.657,1109.24 L591.657,1109.24 Z M586,1089 C577.163,1089 570,1096.16 570,1105 C570,1113.84 577.163,1121 586,1121 C594.837,1121 602,1113.84 602,1105 C602,1096.16 594.837,1089 586,1089 L586,1089 Z' id='cross-circle' sketch:type='MSShapeGroup'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon-select {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:sketch='http://www.bohemiancoding.com/sketch/ns' width='800px' height='800px' viewBox='0 0 32 32' version='1.1'%3E%3Ctitle%3Earrow-up-circle%3C/title%3E%3Cdesc%3ECreated with Sketch Beta.%3C/desc%3E%3Cdefs%3E%3C/defs%3E%3Cg id='Page-1' stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' sketch:type='MSPage'%3E%3Cg id='Icon-Set' sketch:type='MSLayerGroup' transform='translate(-360.000000, -1087.000000)' fill='%23000000'%3E%3Cpath d='M376,1117 C368.268,1117 362,1110.73 362,1103 C362,1095.27 368.268,1089 376,1089 C383.732,1089 390,1095.27 390,1103 C390,1110.73 383.732,1117 376,1117 L376,1117 Z M376,1087 C367.163,1087 360,1094.16 360,1103 C360,1111.84 367.163,1119 376,1119 C384.837,1119 392,1111.84 392,1103 C392,1094.16 384.837,1087 376,1087 L376,1087 Z M376.879,1096.46 C376.639,1096.22 376.311,1096.15 376,1096.21 C375.689,1096.15 375.361,1096.22 375.121,1096.46 L369.465,1102.12 C369.074,1102.51 369.074,1103.14 369.465,1103.54 C369.854,1103.93 370.488,1103.93 370.879,1103.54 L375,1099.41 L375,1110 C375,1110.55 375.447,1111 376,1111 C376.553,1111 377,1110.55 377,1110 L377,1099.41 L381.121,1103.54 C381.512,1103.93 382.145,1103.93 382.535,1103.54 C382.926,1103.14 382.926,1102.51 382.535,1102.12 L376.879,1096.46 L376.879,1096.46 Z' id='arrow-up-circle' sketch:type='MSShapeGroup'%3E%3C/path%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }

            .icon:hover {
                /* background-color: rgba(0, 0, 0, 0.1); */
                transform: scale(1.1);
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-sanitize.min.js"></script>
        <script>
            function appsScriptRun({
                funtionName,
                input = [],
                userObj,
                onSuccess = (result, userObj = undefined) => {
                    console.log("success" + result);
                },
                onError = (result, userObj = undefined) => {
                    console.log("fail" + result);
                },
            }) {
                let runner = google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onError);
                if (userObj) {
                    runner.withUserObject(userObj);
                }
                runner[funtionName](...input);
            }
            async function appsScriptRunAsync(functionName, args) {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        [functionName](...args);
                });
            }
            const isAppsScript = window.location.host.endsWith("-script.googleusercontent.com");
            const isiOS = ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"].includes(navigator.platform) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        </script>
    </head>

    <body ng-controller="MusicAppController as ctrl">
        <!-- Loading Overlay -->
        <div id="loading-overlay" ng-show="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div class="header">
            <!-- <nav class="navbar navbar-expand-lg navbar-dark d-none d-lg-block px-4" style="z-index: 2000"> -->
            <nav class="navbar navbar-expand-lg navbar-dark px-4" style="z-index: 2000">
                <div class="container-fluid">
                    <!-- Toggle button -->
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <!-- Navbar content with collapse -->
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0" style="background-color: #333">
                            <li class="nav-item mx-1">
                                <button class="nav-link" ng-click="ctrl.selectSheetBtnHandler('')">All Song</button>
                            </li>
                            <li class="nav-item mx-1" ng-repeat="name in ctrl.sheetNames">
                                <button ng-class="{ 'nav-link active': name == ctrl.sheet, 'nav-link': name != ctrl.sheet }" ng-click="ctrl.selectSheetBtnHandler(name)">{{name}}</button>
                            </li>
                        </ul>
                        <ul class="navbar-nav list-inline" style="background-color: #333">
                            <li class="nav-item mx-1">
                                <button class="nav-link" ng-click="ctrl.selectByDriveFolderHandler()">ByDriveFolder</button>
                            </li>
                            <li class="nav-item mx-1">
                                <button class="nav-link">
                                    <a href="https://github.com/vannguyen799/MusicApp-AngularJS" target="_blank"> Github </a>
                                </button>
                            </li>
                            <li class="nav-item mx-1">
                                <button class="nav-link" ng-click="ctrl.menu.hidden = !ctrl.menu.hidden">Menu</button>
                            </li>
                            <li class="nav-item mx-1">
                                <button class="nav-link" data-bs-toggle="modal" data-bs-target="#loginModal" ng-if="!ctrl.user">Login/Register</button>
                                <button class="nav-link" ng-if="ctrl.user" ng-click="ctrl.logout()">Logout</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <style>
            .container.self-container {
                padding-top: 15px;
                padding-left: 3%;
                padding-right: 3%;
                max-width: 100%;
                position: relative;
            }
        </style>
        <div class="container self-container">
            <div class="row">
                <div class="col-sm-8" style="border-right: #a0a0a0 thin solid; min-height: 75vh">
                    <style>
                        #menu .card {
                            border-radius: 8px;
                            width: 25%;
                            height: 80px;
                            background-color: var(--bg-color);
                            color: var(--txt-color);
                            border: 1px solid var(--txt-color);
                        }
                        #menu .card:hover {
                            background-color: rgba(95, 239, 247, 0.237);
                            transform: scale(1.04);
                        }
                    </style>
                    <div id="menu">
                        <h1 ng-click="ctrl.menu.hidden = true">Category</h1>
                        <div class="w-100 mx-4" style="display: flex; flex-wrap: wrap">
                            <div class="card m-3 p-1" ng-click="ctrl.selectSheetBtnHandler('')">
                                <div class="card-body">
                                    <h5 class="card-title">All Song</h5>
                                    <p class="card-text"></p>
                                </div>
                            </div>
                            <div class="card m-3 p-1" ng-repeat="name in ctrl.sheetNames" ng-click="ctrl.selectSheetBtnHandler(name)">
                                <div class="card-body">
                                    <h5 class="card-title">{{name}}</h5>
                                    <p class="card-text"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h1 style="align-items: center; justify-items: center; display: flex" title="{{ctrl.songList.length}}">{{ctrl.sheet}} <button style="margin-left: 10px" ng-click="ctrl.playSongList()" ng-if="ctrl.songList" class="icon icon-play"></button></h1>
                        <div style="margin-top: 20px" ng-if="ctrl.message">{{ctrl.message}}</div>

                        <div ng-if="ctrl.songList">
                            <div class="table-action">
                                <label> search: <input name="" placeholder="search" style="border-radius: 10%" ng-model="ctrl.searchValue" /> </label>
                                <style>
                                    .sort-cbx {
                                        justify-self: left;
                                        border-radius: 10%;
                                    }
                                </style>
                                <select class="sort-cbx" ng-model="ctrl.sortBy">
                                    <option value="">--Sort--</option>
                                    <option value="name-asc">Sort by name asc</option>
                                    <option value="name-desc">Sort by name desc</option>
                                    <option value="singer-asc">Sort by singer asc</option>
                                    <option value="singer-desc">Sort by singer desc</option>
                                    <option value="listens-asc">Sort by listens asc</option>
                                    <option value="listens-desc">Sort by listens desc</option>
                                </select>
                            </div>
                            <style>
                                .song-action {
                                    display: flex;
                                    justify-content: flex-end;
                                    align-items: flex-end;
                                }
                                .song-action button {
                                    margin-right: 10px;
                                }
                            </style>
                            <div class="song-table songlisttable" style="min-height: 70vh">
                                <table>
                                    <tr>
                                        <th style="width: 1%"></th>
                                        <th style="width: 40%">Name</th>
                                        <th class="w-25">Singer</th>
                                        <th style="width: 5%">Listens</th>
                                        <th class="" style="width: 13%">Action</th>
                                    </tr>
                                    <tr ng-repeat="s in ctrl.songTable" ng-dblclick="ctrl.form.manageSong.init(s).show()">
                                        <td>
                                            <button
                                                ng-click="ctrl.player.playHandler(s, ctrl.songList)"
                                                ng-class="{
                                                'icon icon-play': s.fileId != ctrl.player.songInfo.fileId || (s.fileId == ctrl.player.songInfo.fileId && ctrl.player.audio.paused),
                                                'icon icon-pause': s.fileId == ctrl.player.songInfo.fileId && !ctrl.player.audio.paused
                                             }"
                                                title="Play"
                                            ></button>
                                        </td>
                                        <td>
                                            {{s.vname == "" ? s.name : s.vname}}
                                            <div class="badge rounded-pill text-bg-secondary" ng-if="isSyncedLRC(s.lyric)">Lyric</div>
                                            <div class="badge rounded-pill text-bg-secondary" ng-if="isSyncedLRC(s.lyric_vn)">Vietsub</div>
                                            <div class="badge rounded-pill text-bg-secondary" ng-if="isSyncedLRC(s.lyric_en)">Engsub</div>
                                        </td>
                                        <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>
                                        <td>{{s.listens}}</td>
                                        <td>
                                            <div class="song-action">
                                                <button
                                                    ng-if="ctrl.form.managePlaylist.isOpen"
                                                    ng-click="ctrl.form.managePlaylist.addHandler(s)"
                                                    ng-class="{
                                                        'icon icon-add': !ctrl.form.managePlaylist.isAdded(s),
                                                        'icon icon-remove': ctrl.form.managePlaylist.isAdded(s)
                                                    }"
                                                    title="PlayList"
                                                ></button>

                                                <button
                                                    class="icon"
                                                    title="Favorite"
                                                    ng-if="ctrl.user"
                                                    ng-class="{
                                                        'icon-unfav': ctrl.user.favorite && ctrl.user.favorite.includes(s.fileId) && !s.isLoadingFav,
                                                        'icon-loading': s.isLoadingFav,
                                                        'icon-fav': !ctrl.user.favorite || !ctrl.user.favorite.includes(s.fileId) && !s.isLoadingFav
                                                    }"
                                                    ng-click="ctrl.favoriteBtnHandler(s)"
                                                ></button>
                                                <!-- <button ng-click="ctrl.form.manageSong.init(s).show()" class="icon icon-select" title="Update"></button> -->
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <style>
                        .modal,
                        .modal-backdrop {
                            position: absolute !important;
                        }
                        .modal-dialog {
                            color: #444444;
                            font-weight: bold;
                        }
                    </style>
                    <div class="modal fade" id="manageSongForm" tabindex="-1" aria-labelledby="manageSongFormLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="manageSongFormLabel">UpdateSong</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form>
                                        <div class="mb-3">
                                            <a target="_blank" href="https://drive.google.com/file/d/{{ctrl.form.manageSong.songInfo.fileId}}/view?usp=drivesdk">https://drive.google.com/file/d/{{ctrl.form.manageSong.songInfo.fileId}}/view?usp=drivesdk</a>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-sm-6">
                                                <label for="_singer" class="form-label">Singer</label>
                                                <input type="text" class="form-control" id="_singer" ng-model="ctrl.form.manageSong.songInfo.singer" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="_vsinger" class="form-label">VSinger</label>
                                                <input type="text" class="form-control" id="_vsinger" ng-model="ctrl.form.manageSong.songInfo.vsinger" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-6">
                                                <label for="_name" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="_name" ng-model="ctrl.form.manageSong.songInfo.name" />
                                            </div>
                                            <div class="col-sm-6">
                                                <label for="_vname" class="form-label">VName</label>
                                                <input type="text" class="form-control" id="_vname" ng-model="ctrl.form.manageSong.songInfo.vname" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4">
                                                <label for="_lrc" class="form-label">Lyric</label>
                                                <textarea rows="10" class="form-control" id="_lrc" ng-model="ctrl.form.manageSong.songInfo.lyric"> </textarea>
                                            </div>
                                            <div class="col-sm-4">
                                                <label for="_lrc_vn" class="form-label">Lyric Vietsub</label>
                                                <textarea rows="10" class="form-control" id="_lrc_vn" ng-model="ctrl.form.manageSong.songInfo.lyric_vn"> </textarea>
                                            </div>
                                            <div class="col-sm-4">
                                                <label for="_lrc_en" class="form-label">Lyric Engsub</label>
                                                <textarea rows="10" class="form-control" id="_lrc_en" ng-model="ctrl.form.manageSong.songInfo.lyric_en"> </textarea>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" ng-click="ctrl.form.manageSong.update()">Update</button>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <!-- <button type="button" class="btn btn-primary">Understood</button> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4 playlist-container" ng-if="ctrl.user">
                    <div class="playlist-top">
                        <h3>Playlist</h3>
                        <button ng-click="ctrl.showCreatePlaylistForm()" class="btn btn-light">{{ctrl.form.managePlaylist.isOpen ? 'CloseForm' : 'Create'}}</button>
                    </div>
                    <div class="managePlaylistForm" ng-if="ctrl.form.managePlaylist.isOpen">
                        <h3>{{ctrl.form.managePlaylist.playlist ? 'Update' : 'Create'}} Playlist</h3>
                        <button ng-click="ctrl.playPlaylistHandler(ctrl.form.managePlaylist.getPlaylist())" ng-if="ctrl.form.managePlaylist.songList.length > 0" class="icon icon-play"></button>
                        <div>
                            <table>
                                <tr>
                                    <td>Playlist name:</td>
                                    <td><input ng-model="ctrl.form.managePlaylist.name" type="text" required /></td>
                                </tr>
                                <tr>
                                    <td>Description:</td>
                                    <td><input ng-model="ctrl.form.managePlaylist.description" type="text" required /></td>
                                </tr>
                            </table>
                        </div>

                        <h4>Songs</h4>

                        <div class="song-table">
                            <table>
                                <tr>
                                    <th style="width: 1%"></th>
                                    <th style="width: 40%">Name</th>
                                    <th style="width: 20%">Singer</th>
                                    <th style="width: auto">Action</th>
                                </tr>
                                <tr ng-repeat="s in ctrl.form.managePlaylist.songList">
                                    <td>
                                        <button
                                            ng-click="ctrl.player.playHandler(s, ctrl.form.managePlaylist.songList)"
                                            ng-class="{
                                            'icon icon-play': s.fileId != ctrl.player.songInfo.fileId || (s.fileId == ctrl.player.songInfo.fileId && ctrl.player.audio.paused),
                                            'icon icon-pause': s.fileId == ctrl.player.songInfo.fileId && !ctrl.player.audio.paused
                                        }"
                                            title="Play"
                                        ></button>
                                    </td>
                                    <td>{{s.vname == "" ? s.name : s.vname}}</td>
                                    <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>
                                    <td>
                                        <div class="song-action">
                                            <button ng-click="ctrl.form.managePlaylist.remove(s)" class="icon icon-remove" title="Remove"></button>

                                            <!-- <button
                                                ng-click="ctrl.favoriteBtnHandler(s)"
                                                ng-class="{
                                                    'icon icon-fav': !s.isFavorite && !s.isLoadingFav,
                                                    'icon icon-unfav': s.isFavorite && !s.isLoadingFav,
                                                    'icon icon-loading': s.isLoadingFav,
                                                }"
                                                title="Favorite"
                                            ></button> -->
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <button
                            class="btn btn-light"
                            style="min-width: 60px; min-height: 28px"
                            ng-click="ctrl.form.managePlaylist.push()"
                            ng-class="{
                                'btn-icon icon-loading':  ctrl.form.managePlaylist.isLoading
                            }"
                        >
                            {{ ctrl.form.managePlaylist.isLoading ? '' : (ctrl.form.managePlaylist.playlist ? 'Update' : 'Create') }}
                        </button>
                    </div>

                    <div class="song-table">
                        <table>
                            <tr>
                                <th style="width: 1%"></th>
                                <th style="width: auto">Name</th>
                                <th style="width: 17%">Description</th>
                                <th style="width: 5%">Count</th>
                                <th style="width: 24%">Action</th>
                            </tr>
                            <tr ng-repeat="p in ctrl.user.playlist" ng-if="ctrl.user.playlist" ng-dblclick="ctrl.selectPlaylistBtnHandler(p)">
                                <td><button ng-click="ctrl.playPlaylistHandler(p)" class="icon icon-play"></button></td>
                                <td>{{p.name}}</td>
                                <td>{{p.description}}</td>
                                <td>{{p.songList.length}}</td>
                                <td>
                                    <div class="song-action">
                                        <button ng-click="ctrl.selectPlaylistBtnHandler(p)" class="icon icon-select"></button>
                                        <button ng-click="ctrl.removePlaylistBtnHandler(p)" class="icon icon-remove"></button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <style>
            #player-pro img {
                border-radius: 6px;
            }
        </style>
        <div id="player-pro" --n-g-if="ctrl.player._playlist.length > 0">
            <div class="container-fluid fixed-bottom px-2" style="background-color: #333; z-index: 1">
                <div class="row p-2">
                    <div class="col-sm-4" ng-dblclick="ctrl.form.manageSong.init(ctrl.player.songInfo).show()">
                        <div class="">
                            <div class="d-flex align-items-center mx-1">
                                <div class="flex-shrink-0">
                                    <img ng-src="{{ ctrl.player.coverImgSrc ?  ctrl.player.coverImgSrc : ctrl.player.defaultCoverImgUrl }}" style="width: 60px; height: 60px" class="align-self-center mr-3" alt="..." />
                                </div>
                                <div class="ms-2 align-items-center">
                                    <div class="text-truncate fs-5" style="max-width: 450px" title="{{ctrl.player.songInfo.vname ? ctrl.player.songInfo.vname + ' - ' + ctrl.player.songInfo.name : ctrl.player.songInfo.name }}">{{ctrl.player.songInfo.vname ? ctrl.player.songInfo.vname + ' / ' + ctrl.player.songInfo.name : ctrl.player.songInfo.name}} <span class="badge fs-6">{{ctrl.player.currentExt.toUpperCase()}}</span></div>
                                    <div class="text-truncate fs-6 fst-normal" style="max-width: 450px" title="{{ctrl.player.songInfo.vsinger ? ctrl.player.songInfo.vsinger + ' - ' + ctrl.player.songInfo.singer: ctrl.player.songInfo.singer}}">{{ctrl.player.songInfo.vsinger ? ctrl.player.songInfo.vsinger + ' / ' + ctrl.player.songInfo.singer: ctrl.player.songInfo.singer}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                        .player-icon {
                            width: 25px;
                            height: 25px;
                            border-radius: 6px;
                            border: none;
                            cursor: pointer;
                            outline: none;
                            background-color: transparent;
                            transition: background-color 0.2s, transform 0.2s;
                            background-size: 70% 70%;
                            background-repeat: no-repeat;
                            background-position: center;
                            filter: invert(0.9) sepia(0.1) saturate(2) hue-rotate(180deg) brightness(1.2);
                        }
                        .player-icon:hover {
                            background-color: #1a73e863;
                            transform: scale(1.2);
                        }
                        .player-icon.i-selected {
                            background-color: #1a73e8;
                        }
                        .i-player-fullscreen {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800px' height='800px' viewBox='0 0 24 24' fill='none'%3E%3Cpath stroke='%23000000' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8.5V4M4 4H8.5M4 4L9.5 9.5M20 8.5V4M20 4H15.5M20 4L14.5 9.5M4 15.5V20M4 20H8.5M4 20L9.5 14.5M20 15.5V20M20 20H15.5M20 20L14.5 14.5'/%3E%3C/svg%3E");
                            transform: scale(1.21);
                        }
                        .i-player-play {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800px' height='800px' viewBox='0 0 24 24' fill='none'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M5.46484 3.92349C4.79896 3.5739 4 4.05683 4 4.80888V19.1911C4 19.9432 4.79896 20.4261 5.46483 20.0765L19.1622 12.8854C19.8758 12.5108 19.8758 11.4892 19.1622 11.1146L5.46484 3.92349ZM2 4.80888C2 2.55271 4.3969 1.10395 6.39451 2.15269L20.0919 9.34382C22.2326 10.4677 22.2325 13.5324 20.0919 14.6562L6.3945 21.8473C4.39689 22.8961 2 21.4473 2 19.1911V4.80888Z' fill='%230F0F0F'/%3E%3C/svg%3E");
                        }
                        .i-player-pause {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800px' height='800px' viewBox='0 0 24 24' fill='none'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M10 5C10 3.34315 8.65686 2 7 2H5C3.34315 2 2 3.34315 2 5V19C2 20.6569 3.34315 22 5 22H7C8.65686 22 10 20.6569 10 19V5ZM8 5C8 4.44772 7.55229 4 7 4H5C4.44772 4 4 4.44772 4 5V19C4 19.5523 4.44772 20 5 20H7C7.55229 20 8 19.5523 8 19V5Z' fill='%230F0F0F'/%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M22 5C22 3.34315 20.6569 2 19 2H17C15.3431 2 14 3.34315 14 5V19C14 20.6569 15.3431 22 17 22H19C20.6569 22 22 20.6569 22 19V5ZM20 5C20 4.44772 19.5523 4 19 4H17C16.4477 4 16 4.44772 16 5V19C16 19.5523 16.4477 20 17 20H19C19.5523 20 20 19.5523 20 19V5Z' fill='%230F0F0F'/%3E%3C/svg%3E");
                        }
                        .i-player-next {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800px' height='800px' viewBox='0 0 24 24' fill='none'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M5.60439 4.23093C4.94586 3.73136 4 4.20105 4 5.02762V18.9724C4 19.799 4.94586 20.2686 5.60439 19.7691L14.7952 12.7967C15.3227 12.3965 15.3227 11.6035 14.7952 11.2033L5.60439 4.23093ZM2 5.02762C2 2.54789 4.83758 1.13883 6.81316 2.63755L16.004 9.60993C17.5865 10.8104 17.5865 13.1896 16.004 14.3901L6.81316 21.3625C4.83758 22.8612 2 21.4521 2 18.9724V5.02762Z' fill='%230F0F0F'/%3E%3Cpath d='M20 3C20 2.44772 20.4477 2 21 2C21.5523 2 22 2.44772 22 3V21C22 21.5523 21.5523 22 21 22C20.4477 22 20 21.5523 20 21V3Z' fill='%230F0F0F'/%3E%3C/svg%3E");
                        }
                        .i-player-prev {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800px' height='800px' viewBox='0 0 24 24' fill='none'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M18.3956 19.7691C19.0541 20.2687 20 19.799 20 18.9724L20 5.02764C20 4.20106 19.0541 3.73137 18.3956 4.23095L9.20476 11.2033C8.67727 11.6035 8.67727 12.3965 9.20476 12.7967L18.3956 19.7691ZM22 18.9724C22 21.4521 19.1624 22.8612 17.1868 21.3625L7.99598 14.3901C6.41353 13.1896 6.41353 10.8104 7.99599 9.60994L17.1868 2.63757C19.1624 1.13885 22 2.5479 22 5.02764L22 18.9724Z' fill='%230F0F0F'/%3E%3Cpath d='M2 3C2 2.44772 2.44772 2 3 2C3.55228 2 4 2.44772 4 3V21C4 21.5523 3.55228 22 3 22C2.44772 22 2 21.5523 2 21V3Z' fill='%230F0F0F'/%3E%3C/svg%3E");
                        }
                        .i-player-loop-1 {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-repeat-once'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3' /%3E%3Cpath d='M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3' /%3E%3Cpath d='M11 11l1 -1v4' /%3E%3C/svg%3E");
                        }
                        .i-player-loop {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-repeat'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3' /%3E%3Cpath d='M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3' /%3E%3C/svg%3E");
                        }
                        .i-player-rand {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23000000' width='800px' height='800px' viewBox='0 0 256 256' id='Flat'%3E%3Cpath d='M237.65723,178.34277a8.00122,8.00122,0,0,1,0,11.31446l-24,24A8.00066,8.00066,0,0,1,200,208V191.98584a72.13911,72.13911,0,0,1-57.65332-30.13721L100.63379,103.4502A56.11029,56.11029,0,0,0,55.06445,80H32a8,8,0,0,1,0-16H55.06445a72.14126,72.14126,0,0,1,58.58887,30.15137l41.71289,58.39843A56.0996,56.0996,0,0,0,200,175.97168V160a8.00065,8.00065,0,0,1,13.65723-5.65723Zm-94.64356-71.36132a7.99621,7.99621,0,0,0,11.15918-1.86036l1.19336-1.67089A56.0996,56.0996,0,0,1,200,80.02832V96a8.00053,8.00053,0,0,0,13.65723,5.65723l24-24a8.00122,8.00122,0,0,0,0-11.31446l-24-24A8.00065,8.00065,0,0,0,200,48V64.01416a72.13911,72.13911,0,0,0-57.65332,30.13721l-1.19336,1.6709A7.9986,7.9986,0,0,0,143.01367,106.98145Zm-30.02734,42.0371a7.99642,7.99642,0,0,0-11.15918,1.86036l-1.19336,1.67089A56.11029,56.11029,0,0,1,55.06445,176H32a8,8,0,0,0,0,16H55.06445a72.14126,72.14126,0,0,0,58.58887-30.15137l1.19336-1.6709A7.9986,7.9986,0,0,0,112.98633,149.01855Z'/%3E%3C/svg%3E");
                        }
                        .i-player-setting {
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800px' height='800px' viewBox='0 0 48 48' fill='none'%3E%3Crect width='48' height='48' fill='white' fill-opacity='0.01'/%3E%3Cpath d='M41.5 10H35.5' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M27.5 6V14' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M27.5 10L5.5 10' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M13.5 24H5.5' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M21.5 20V28' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M43.5 24H21.5' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M41.5 38H35.5' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M27.5 34V42' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M27.5 38H5.5' stroke='%23000000' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
                        }
                        .i-player-speaker {
                            background-image: url("data:image/svg+xml,%3Csvg width='800px' height='800px' viewBox='0 0 28 28' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M6.48542 18.6893L13.0821 25.1703C14.8862 26.9427 17.971 25.6874 17.971 23.1808V4.81925C17.971 2.3126 14.8862 1.05725 13.0821 2.82973L6.48542 9.31065H3.43958C2.09223 9.31065 1 10.3837 1 11.7074V16.2926C1 17.6163 2.09224 18.6893 3.43958 18.6893H6.48542ZM7.58159 16.8188L14.5821 23.6966C15.0499 24.1561 15.8496 23.8306 15.8496 23.1808V4.81925C15.8496 4.16938 15.0499 3.84392 14.5821 4.30345L7.58159 11.1812C7.44234 11.318 7.36412 11.5035 7.36412 11.697V16.303C7.36412 16.4965 7.44234 16.682 7.58159 16.8188ZM5.24275 11.3948H3.43958C3.26384 11.3948 3.12137 11.5348 3.12137 11.7074V16.2926C3.12137 16.4652 3.26384 16.6052 3.43958 16.6052H5.24275V11.3948Z' fill='%23000000' fill-rule='evenodd'/%3E%3Cpath d='M22.7437 22.3364C22.2813 21.9831 22.2015 21.3302 22.5283 20.8526C25.3157 16.7793 25.9181 11.5645 22.7053 7.69395C22.3351 7.24793 22.3295 6.59119 22.7437 6.18423C23.158 5.77727 23.835 5.77583 24.214 6.21465C28.3909 11.0506 27.4383 17.4771 24.2055 22.1342C23.8755 22.6097 23.2061 22.6898 22.7437 22.3364Z' fill='%23000000'/%3E%3Cpath d='M20.8216 13.6463C20.7817 12.5486 20.5055 11.6062 20.1251 10.9429C19.8376 10.4415 19.7402 9.77098 20.0917 9.31056C20.4431 8.85015 21.1179 8.75448 21.4848 9.20319C22.411 10.3362 22.884 11.9871 22.9416 13.5719C23.0032 15.266 22.6045 17.1437 21.5255 18.631C21.1855 19.0996 20.5059 19.0962 20.0917 18.6893C19.6774 18.2823 19.688 17.6242 19.9906 17.1314C20.5942 16.1482 20.867 14.897 20.8216 13.6463Z' fill='%23000000'/%3E%3C/svg%3E");
                        }
                        .i-player-speaker-muted {
                            background-image: url("data:image/svg+xml,%3Csvg width='800px' height='800px' viewBox='0 0 28 28' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M6.4948 9.31065L13.1027 2.82973C14.91 1.05725 18 2.3126 18 4.81925V23.1808C18 25.6874 14.9099 26.9427 13.1027 25.1703L6.4948 18.6893H3.44375C2.0941 18.6893 1 17.6163 1 16.2926V11.7074C1 10.3837 2.0941 9.31065 3.44375 9.31065H6.4948ZM3.44375 11.3948C3.26771 11.3948 3.125 11.5348 3.125 11.7074V16.2926C3.125 16.4652 3.26771 16.6052 3.44375 16.6052H5.25V11.3948H3.44375ZM7.59284 16.8188C7.45336 16.682 7.375 16.4965 7.375 16.303V11.697C7.375 11.5035 7.45336 11.318 7.59284 11.1812L14.6053 4.30345C15.0739 3.84392 15.875 4.16938 15.875 4.81925V23.1808C15.875 23.8306 15.0739 24.1561 14.6053 23.6966L7.59284 16.8188Z' fill='%23000000' fill-rule='evenodd'/%3E%3Cpath d='M20.7071 12.1212C20.3166 11.7306 20.3166 11.0975 20.7071 10.707C21.0976 10.3164 21.7308 10.3164 22.1213 10.707L23.8887 12.4743L25.656 10.707C26.0465 10.3164 26.6797 10.3164 27.0702 10.707C27.4608 11.0975 27.4608 11.7306 27.0702 12.1212L25.3029 13.8885L27.0711 15.6567C27.4616 16.0472 27.4616 16.6804 27.0711 17.0709C26.6805 17.4614 26.0474 17.4614 25.6569 17.0709L23.8887 15.3027L22.1205 17.0709C21.73 17.4614 21.0968 17.4614 20.7063 17.0709C20.3158 16.6804 20.3158 16.0472 20.7063 15.6567L22.4745 13.8885L20.7071 12.1212Z' fill='%23000000'/%3E%3C/svg%3E");
                        }
                        .i-player-playlist {
                            background-image: url("data:image/svg+xml,%3Csvg width='800px' height='800px' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M16 5V18M16 18C16 19.1046 14.6569 20 13 20C11.3431 20 10 19.1046 10 18C10 16.8954 11.3431 16 13 16C14.6569 16 16 16.8954 16 18ZM4 5H12M4 9H12M4 13H8M16 4L20 3V7L16 8V4Z' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
                        }
                    </style>
                    <div class="col-sm-4 align-items-end pb-0">
                        <div class="play-icons text-white align-items-center d-flex justify-content-center">
                            <button
                                class="mx-2 my-1"
                                ng-class="{
                                    'player-icon i-player-rand i-selected ': ctrl.player.isRandomPlay,
                                    'player-icon i-player-rand': !ctrl.player.isRandomPlay,
                                }"
                                ng-click="ctrl.player.isRandomPlay = !ctrl.player.isRandomPlay"
                            ></button>
                            <button class="player-icon i-player-prev mx-2 my-1" ng-click="ctrl.player.prev()"></button>
                            <button
                                class="mx-2 my-1"
                                ng-class="{
                                    'player-icon i-player-play': !ctrl.player.isPlaying,
                                    'player-icon i-player-pause i-selected': ctrl.player.isPlaying
                                }"
                                ng-click="ctrl.player.playHandler()"
                            ></button>
                            <button class="player-icon i-player-next mx-2 my-1" ng-click="ctrl.player.next() "></button>
                            <button
                                class="mx-2 my-1"
                                ng-class="{
                                    'player-icon i-player-loop ': ctrl.player.loopMode == 0,
                                    'player-icon i-player-loop-1 i-selected': ctrl.player.loopMode == 1,
                                    'player-icon i-player-loop i-selected ': ctrl.player.loopMode == 2,
                                }"
                                ng-click="ctrl.player.loopMode = (ctrl.player.loopMode+1)%3"
                            ></button>
                        </div>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.current) }}</div>
                            <div class="mx-1" style="margin-top: -8px">
                                <input class="range" id="audioTimeRange" style="width: 25vw; height: 2px" type="range" step="0.1" min="0" max="{{ ctrl.player.in4.duration }}" aria-valuemin="0" aria-valuemax="{{ ctrl.player.in4.duration }}" aria-valuenow="{{ ctrl.player.in4.current }}" value="0" />
                            </div>
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.duration) }}</div>
                        </div>
                        <!-- <div class="d-flex align-items-center justify-content-center">
                            <div class="" style="font-size: smaller">{{ ctrl.player.metadata.string }}</div>
                        </div> -->
                    </div>
                    <div class="col-sm-4 text-white d-inline-flex flex-row-reverse align-items-center">
                        <div class="ml-2 mx-1"><button class="player-icon i-player-setting" id="settingBtn"></button></div>
                        <div class="ml-2 mx-1">
                            <button
                                ng-class="{
                                    'player-icon i-player-speaker': !ctrl.player.in4.volume.isMuted,
                                    'player-icon i-player-speaker-muted': ctrl.player.in4.volume.isMuted
                                }"
                                ng-click="ctrl.player.speakerBtnHandle()"
                                id="speakerBtn"
                            ></button>
                        </div>
                        <div class="ml-2 mx-1"><button id="playlistBtn" class="player-icon i-player-playlist"></button></div>
                        <div class="ml-2 mx-1"><button class="player-icon i-player-fullscreen" id="fullScreebBtn" ng-click="ctrl.player.showFc()"></button></div>
                    </div>
                </div>
            </div>
        </div>
        <style>
            /* Make the div take up 100% of the viewport width and height */
            #player-fc {
                width: 100vw;
                height: 100vh;
                padding: 2%;
                background-color: #008da3;
                color: white;
                font-size: 24px;
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000; /* Ensure it appears on top */
            }

            #player-fc img.song-cover {
                border-radius: 16px;
                box-shadow: 5px 5px 5px 5px #45454563;
                border: 2px solid #45454563;
            }
            #player-fc .player-icon {
                /* width: 25px; */
                transform: scale(1.5);
                padding: 15px;
                /* margin: 15px; */
                background-size: 60% 60%;
            }
            #player-fc .i-player-playlist,
            #player-fc .i-player-speaker,
            #player-fc .i-player-speaker-muted,
            #player-fc .i-player-setting {
                transform: scale(1.2);
            }
        </style>
        <div id="player-fc">
            <div class="row w-100" style="height: 85%">
                <div class="col-sm-4 d-flex justify-content-end align-items-end p-4">
                    <div class="">
                        <img class="song-cover" ng-src="{{ ctrl.player.coverImgSrc ?  ctrl.player.coverImgSrc : ctrl.player.defaultCoverImgUrl }}" style="width: 333px; height: 333px" />
                    </div>
                </div>
                <div class="col-sm-8 position-relative p-4">
                    <div class="row d-inline-flex justify-content-end w-100" style="height: 10%"><button class="icon icon-remove" ng-click="ctrl.player.hideFc()" title="Close"></button></div>
                    <div class="row h-65">
                        <div class="col-12" style="font-weight: normal">
                            <div class="row justify-content-center align-content-center pb-1 fs-3" id="lyric"></div>
                            <div class="row justify-content-center align-content-center pb-2 fs-5" id="supLyric"></div>
                            <div class="row d-flex justify-content-center align-items-center pb-1 fs-4" id="vnLyric"></div>
                            <div class="row justify-content-center align-content-center py-0 fs-4" id="enLyric"></div>
                        </div>
                    </div>
                    <div class="row h-auto position-absolute bottom-0 p-4">
                        <div class="" style="font-size: 35px">
                            {{ctrl.player.mainSongName}} {{ ctrl.player.in4.speed && ctrl.player.in4.speed == 1 ? '' : ctrl.player.in4.speed +'x' }}
                            <!-- <span class="badge" style="color: #333; background-color: var(--line-color); filter: invert(0.9) sepia(0.1) saturate(2) hue-rotate(180deg) brightness(1.2)">{{ctrl.player.currentExt.toUpperCase()}}</span> -->
                        </div>
                        <div class="" style="font-size: 20px; font-weight: normal">{{ctrl.player.subSongName}}</div>
                    </div>
                </div>
            </div>
            <div class="row h-auto w-100">
                <div class="col-sm-12 align-items-end pb-0">
                    <div class="row w-100">
                        <div class="d-flex align-items-center justify-content-center fs-5">
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.current) }}</div>
                            <div class="range mx-1">
                                <input id="audioTimeRange-fc" style="width: 80vw; height: 4px" type="range" step="0.3" min="0" max="{{ ctrl.player.in4.duration }}" aria-valuemin="0" aria-valuemax="{{ ctrl.player.in4.duration }}" aria-valuenow="{{ ctrl.player.in4.current }}" value="0" />
                            </div>
                            <div class="mx-1">{{ secToMin(ctrl.player.in4.duration) }}</div>
                        </div>
                    </div>
                    <!-- <div class="d-flex align-items-center justify-content-center">
                        <div class="" style="font-size: smaller">[No Lyrics]</div>
                    </div> -->
                    <div class="row mt-4">
                        <div class="col-sm-4"></div>
                        <!-- control -->
                        <div class="col-sm-4 play-icons text-white align-items-center d-flex justify-content-center">
                            <button
                                class="mx-4"
                                ng-class="{
                                    'player-icon i-player-rand i-selected ': ctrl.player.isRandomPlay,
                                    'player-icon i-player-rand': !ctrl.player.isRandomPlay,
                                }"
                                ng-click="ctrl.player.isRandomPlay = !ctrl.player.isRandomPlay"
                            ></button>
                            <button class="player-icon i-player-prev mx-4" ng-click="ctrl.player.prev()"></button>
                            <button
                                class="mx-4"
                                ng-class="{
                                    'player-icon i-player-play': !ctrl.player.isPlaying,
                                    'player-icon i-player-pause i-selected': ctrl.player.isPlaying
                                }"
                                ng-click="ctrl.player.playHandler()"
                            ></button>
                            <button class="player-icon i-player-next mx-4" ng-click="ctrl.player.next() "></button>
                            <button
                                class="mx-4"
                                ng-class="{
                                    'player-icon i-player-loop ': ctrl.player.loopMode == 0,
                                    'player-icon i-player-loop-1 i-selected': ctrl.player.loopMode == 1,
                                    'player-icon i-player-loop i-selected ': ctrl.player.loopMode == 2,
                                }"
                                ng-click="ctrl.player.loopMode = (ctrl.player.loopMode+1)%3"
                            ></button>
                        </div>
                        <!-- setting  -->
                        <div class="col-sm-4 play-icons text-white align-items-center d-flex justify-content-end">
                            <div class="mx-3"><button class="player-icon i-player-setting" id="settingBtn-fc"></button></div>
                            <div class="mx-3">
                                <button
                                    ng-class="{
                                        'player-icon i-player-speaker': !ctrl.player.in4.volume.isMuted,
                                        'player-icon i-player-speaker-muted': ctrl.player.in4.volume.isMuted
                                    }"
                                    ng-click="ctrl.player.speakerBtnHandle()"
                                    id="speakerBtn-fc"
                                ></button>
                            </div>
                            <div class="mx-3"><button id="playlistBtn-fc" class="player-icon i-player-playlist"></button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-none">
            <style>
                .propover-p {
                    font-size: small;
                }
                .propover-p .icon {
                    filter: unset;
                }
                .popover {
                    background-color: whitesmoke;
                    border: 1px solid var(--line-color);
                    border-radius: 10px;
                    max-width: 50%;
                }
                .propover-p th {
                    background-color: whitesmoke;
                }
            </style>
            <div class="propover-p" id="speakerPopover" ng-if="!ctrl.player.in4.volume.isMuted">
                <input type="range" step="1" min="0" max="100" ng-model="ctrl.player.in4.volume.value" ng-value="ctrl.player.in4.volume.value" />
            </div>
            <div id="settingPopover" class="w-75 propover-p">
                <table>
                    <tr>
                        <td>Speed</td>
                        <td><input type="number" step="0.01" ng-model="ctrl.player.in4.speed" /></td>
                    </tr>
                    <tr>
                        <td>LyricAutoTranslate</td>
                        <td class="form-check form-switch">
                            <input class="form-check-input" style="width: 2.8em; height: 1.3em" type="checkbox" role="switch" ng-model="ctrl.config.lyricAutoTranslate" />
                        </td>
                    </tr>
                </table>
            </div>
            <div id="playlistPopover" class="propover-p">
                <h3>Current Playlist</h3>

                <div class="song-table">
                    <table>
                        <tr>
                            <th style="max-width: 20%">Action</th>
                            <th style="max-width: 200px">Name</th>
                            <th style="max-width: 20%">Singer</th>
                        </tr>
                        <tr ng-repeat="s in ctrl.player.playlist">
                            <!-- <td>{{i + 1}}</td> -->
                            <td>
                                <div class="song-action">
                                    <button
                                        ng-click="ctrl.player.playHandler(s)"
                                        ng-class="{
                                            'icon icon-play': s.fileId != ctrl.player.songInfo.fileId || (s.fileId == ctrl.player.songInfo.fileId && ctrl.player.audio.paused),
                                            'icon icon-pause': s.fileId == ctrl.player.songInfo.fileId && !ctrl.player.audio.paused
                                        }"
                                        title="Play"
                                    ></button>
                                    <!-- <button
                                        ng-click="ctrl.favoriteBtnHandler(s)"
                                        ng-class="{
                                            'icon icon-fav': !s.isFavorite && !s.isLoadingFav,
                                            'icon icon-unfav': s.isFavorite && !s.isLoadingFav,
                                            'icon icon-loading': s.isLoadingFav,
                                        }"
                                        title="Favorite"
                                    ></button> -->
                                </div>
                            </td>
                            <td>{{s.vname == "" ? s.name : s.vname}}</td>
                            <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="">
            <!-- Sign-Up Modal -->
            <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="signupModalLabel">Register</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label for="signupEmail" class="form-label">Username</label>
                                    <input type="text" minlength="3" class="form-control" id="signupEmail" placeholder="Enter Username" ng-model="ctrl.form.register.username" />
                                </div>
                                <div class="mb-3">
                                    <label for="signupPassword" class="form-label">Password</label>
                                    <input type="password" minlength="3" class="form-control" id="signupPassword" placeholder="Password" ng-model="ctrl.form.register.password" />
                                </div>
                                <!-- <div class="mb-3">
                                    <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="signupConfirmPassword" placeholder="Confirm Password" />
                                </div> -->
                                <button class="btn btn-primary" ng-click="ctrl.form.register.push()">Register</button>
                                <div class="btn btn-light align-self-end" data-bs-toggle="modal" data-bs-target="#loginModal">Log In</div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Login Modal -->
            <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="loginModalLabel">Login</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label for="loginEmail" class="form-label">Username</label>
                                    <input type="text" minlength="3" class="form-control" id="loginEmail" placeholder="Enter Username" ng-model="ctrl.form.login.username" />
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" minlength="3" class="form-control" id="loginPassword" placeholder="Password" ng-model="ctrl.form.login.password" />
                                </div>
                                <button class="btn btn-primary" ng-click="ctrl.form.login.push()">Login</button>
                                <div class="btn btn-light" data-bs-toggle="modal" data-bs-target="#signupModal">Register</div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Loading Modal -->
        <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center">
                    <div class="modal-body">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading, please wait...</p>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script> -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js" integrity="sha512-YsR46MmyChktsyMMou+Bs74oCa/CDdwft7rJ5wlnmDzMj1mzqncsfJamEEf99Nk7IB0JpTMo5hS8rxB49FUktQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/pinyin@4.0.0-alpha.2/dist/pinyin.js"></script>
        <script>
            // var exports = {};
            document.addEventListener("DOMContentLoaded", function () {
                const spkPopover = configPopover("#speakerBtn", "#speakerPopover");
                const stgPopover = configPopover("#settingBtn", "#settingPopover", { trigger: "click hover" });
                const playlistPropover = configPopover("#playlistBtn", "#playlistPopover", { trigger: "click hover" });
                const spkPopoverfc = configPopover("#speakerBtn-fc", "#speakerPopover");
                const stgPopoverfc = configPopover("#settingBtn-fc", "#settingPopover", { trigger: "click hover" });
                const playlistPropoverfc = configPopover("#playlistBtn-fc", "#playlistPopover", { trigger: "click hover" });
            });
            function closeAllPopover() {
                // Select all elements that have popovers
                const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));

                // Iterate through each element and hide its popover
                popoverTriggerList.forEach(function (popoverTriggerEl) {
                    const popoverInstance = bootstrap.Popover.getInstance(popoverTriggerEl);
                    if (popoverInstance) {
                        popoverInstance.hide();
                    }
                });
            }

            function configPopover(btnSelector, contentSelector, opt = {}) {
                const content = document.querySelector(contentSelector);
                const btn = document.querySelector(btnSelector);
                const popover = new bootstrap.Popover(btn, {
                    trigger: opt["trigger"] ?? "manual",
                    html: true,
                    content: content,
                    placement: "top",
                    fallbackPlacements: [], // Disable automatic placement flipping
                });
                function isHovering(_e, pop_e) {
                    return _e.matches(":hover");
                }

                if (!opt["trigger"]) {
                    btn.addEventListener("mouseenter", function () {
                        setTimeout(function () {
                            if (isHovering(btn)) {
                                popover.show();
                            }
                        }, 200);
                    });

                    btn.addEventListener("mouseleave", function () {
                        setTimeout(function () {
                            if (!document.querySelector(contentSelector + ":hover") && !isHovering(btn)) {
                                popover.hide();
                            }
                        }, 400);
                    });
                    content.addEventListener("mouseleave", function () {
                        setTimeout(function () {
                            if (!document.querySelector(contentSelector + ":hover") && !isHovering(btn)) {
                                popover.hide();
                            }
                        }, 400);
                    });
                    return popover;
                }
            }
            class LyricLRC {
                constructor(lyricString) {
                    // console.log("updatelrc");
                    this.lyricsString = lyricString;
                    const lines = lyricString.split("\n");
                    const lineRegex = /\[(\d{1,2}):(\d{1,2})(?:\.(\d{2,3}))?\]\s?(.*)/;
                    const offsetRegex = /\[offset:(.*?)\]/;
                    const translate = /\[translate:(.*?)\]/;

                    this.lyrics = {
                        offset: 0,
                        data: [],
                        translator: "",
                    };

                    /// read LRC
                    for (const [i, line] of lines.entries()) {
                        let l;
                        if ((l = line.match(lineRegex))) {
                            this.lyrics.data.push({
                                startTime: parseInt(l[1]) * 60 + parseInt(l[2]) + parseFloat("0." + l[3]),
                                text: l[4].trim(),
                            });
                            continue;
                        }
                        if ((l = line.match(offsetRegex))) {
                            this.lyrics.offset = l[1] / 1000;
                            continue;
                        }
                        if ((l = line.match(translate))) {
                            this.lyrics.translator = l[1];
                            continue;
                        }
                    }
                    this.lyrics.data.map((lyric, i) => {
                        if (i < this.lyrics.data.length - 1) {
                            lyric.endTime = this.lyrics.data[i + 1].startTime;
                        } else {
                            lyric.endTime = 60 * 60;
                        }
                        return lyric;
                    });

                    this.getLyrics_nextIndex = 0;
                }
                /** @params {number} timeAt */
                getLyricsF(timeAt, allowTranslated = false) {
                    if (!allowTranslated && this.lyrics.translator != "") return "";
                    const text = this.lyrics.data.find((d) => d.startTime < timeAt && d.endTime > timeAt)?.text || "";
                    if (allowTranslated && text != "" && this.lyrics.translator != "") {
                        return `
<span class="d-flex justify-content-center align-items-center"> 
    ${text}&nbsp;
    <img src="https://upload.wikimedia.org/wikipedia/commons/d/db/Google_Translate_Icon.png" alt="description" style="width: 1em; height: auto">
</span>
                           `;
                    }
                    return text;
                }
                getLyrics(timeAt, allowTranslated = false) {
                    const { data, offset } = this.lyrics;
                    if (data.length == 0) return "";

                    timeAt = parseFloat(timeAt) + offset;

                    return this.getLyricsF(timeAt, allowTranslated);

                    let lyric = data[this.getLyrics_nextIndex % data.length];

                    if (timeAt > lyric.startTime && timeAt < lyric.endTime) {
                        console.log(this.getLyrics_nextIndex, timeAt, lyric.startTime, lyric.text);
                        this.getLyrics_nextIndex++;
                        return lyric.text;
                    }

                    try {
                        const prevLyric = data[(this.getLyrics_nextIndex - 1) % data.length];
                        const nextLyric = data[(this.getLyrics_nextIndex + 1) % data.length];
                        if (timeAt < prevLyric.startTime || timeAt > nextLyric.endTime) {
                            let r = data.findIndex((l) => l.startTime < timeAt && l.endTime > timeAt);
                            if (r) {
                                this.getLyrics_nextIndex = r + 1;
                                return data[r].text;
                            }
                        }
                    } catch (e) {
                        console.log(e);
                    }
                }
            }
        </script>
        <script>
            // const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const loadingModal = new bootstrap.Modal(document.getElementById("loadingModal"));

            const cfg = {
                ins: undefined,
                preloadRate: 0.75,
                preload: true,
            };

            class MusicAppController {
                constructor($scope, $sce, $timeout, $http, DataService, AuthService) {
                    const ctrl = this;
                    cfg.ins = ctrl;
                    this.config = {
                        lyricAutoTranslate: true,
                    };
                    this.$scope = $scope;
                    this.$sce = $sce;
                    this.$timeout = $timeout;
                    this.$http = $http;
                    this.MSService = new MusicSourceService($http);
                    this.DataService = DataService;
                    this.AuthService = AuthService;
                    this.menu = document.getElementById("menu");
                    this.sortBy = "";
                    this.playlist = [];
                    const timer = { setPlaybackRateTimer: undefined };
                    const urlRvk = [];
                    // this.fileId = "<?= fileId?>";
                    this.sheet = "<?= sheet?>";
                    this.message = "";
                    this.keyList = [];
                    this.songList = undefined;
                    this.player = {
                        audioTimeRanges: [document.querySelector("#audioTimeRange"), document.querySelector("#audioTimeRange-fc")],
                        init: function ($scope) {
                            const player = this;
                            $scope.secToMin = secToMin;
                            $scope.$watch(
                                () => player.in4.volume.value,
                                function (newValue, oldValue) {
                                    if (newValue !== oldValue) player.setSpeakerValue(newValue);
                                },
                            );
                            $scope.$watch(
                                () => this.in4.speed,
                                (newValue, oldValue) => {
                                    if (newValue !== oldValue) {
                                        clearTimeout(timer.setPlaybackRateTimer);
                                        timer.setPlaybackRateTimer = setTimeout(() => player.setPlaybackRate(newValue), 2000);
                                    }
                                },
                            );
                            for (const e of this.audioTimeRanges) {
                                e.addEventListener("change", (event) => {
                                    console.log(player.in4.current, ">", event.target.value);
                                    player.audio.currentTime = event.target.value;
                                });
                            }
                        },
                        in4: {
                            duration: "0",
                            current: "0",
                            volume: {
                                isMuted: false,
                                value: 75,
                            },
                            changeTime: 0,
                            speed: 1,
                        },
                        metadata: {},
                        _playlist: [],
                        _favlist: [],
                        playlist: [],
                        prevPlaylist: [],
                        favlist: [],
                        // audio element
                        audio: new Audio(),
                        setPlaybackRate(_val) {
                            if (_val == player.audio.playbackRate) {
                                return;
                            }
                            this.audio.pause();
                            this.audio.playbackRate = parseFloat(_val);
                            setTimeout(() => {
                                this.audio.play();
                            }, 200);
                        },
                        setSpeakerValue(_val) {
                            if (_val && (_val > 0 || _val <= 100)) {
                                _val = parseFloat(_val);
                                this.audio.volume = _val / 100;
                            } else {
                                this.audio.volume = 0;
                            }
                        },
                        isPlaying: false,
                        generateAudioEvent() {
                            this.setSpeakerValue(this.in4.volume.value);
                            const audio = this.audio;
                            let audioLog = {};
                            function updateRange_() {}
                            audio.addEventListener("timeupdate", () => {
                                this.in4.current = audio.currentTime;
                                for (const e of this.audioTimeRanges) {
                                    e.value = this.in4.current;
                                }
                                this.updateLyric(this.in4.current);

                                if (this.in4.current > 0) {
                                    this.isPlaying = true;
                                }
                                // preparing next song

                                if (cfg.preload && !this.refresh.rdn && this.in4.current / audio.duration > parseFloat(cfg.preloadRate)) {
                                    console.log("enter rdns");
                                    this.refresh.rdn = true;
                                    this._readyNextSong();
                                }

                                if (!audioLog.songInfo || audioLog.songInfo.fileId != this.songInfo.fileId) {
                                    audioLog = {
                                        songInfo: this.songInfo,
                                        count: 0,
                                        lastT: 0,
                                        done: false,
                                    };
                                } else {
                                    if (audioLog.songInfo && audioLog.songInfo.fileId == this.songInfo.fileId && audio.currentTime <= 1 && audioLog.lastT > audio.currentTime) {
                                        audioLog = {
                                            songInfo: this.songInfo,
                                            count: 0,
                                            lastT: 0,
                                            done: false,
                                        };
                                    }
                                }
                                audioLog.count += audio.currentTime - audioLog.lastT;
                                audioLog.lastT = audio.currentTime;
                                if (!audioLog.done && audio.duration / 2 < audioLog.count) {
                                    let s = audioLog.songInfo;
                                    audioLog.done = true;
                                    console.log("1viewup");
                                    ctrl.DataService.addListens(s).then((result) => {
                                        if (result.fileId) {
                                            ctrl.tryApply();
                                        }
                                    });
                                    this.songInfo.listens++;
                                }
                                ctrl.tryApply();
                            });
                            audio.addEventListener("ended", () => {
                                this.next();
                                ctrl.tryApply();
                            });
                            audio.addEventListener("canplay", () => {
                                this.in4.duration = audio.duration;
                                this.loadMetadata();
                                ctrl.tryApply();
                            });
                            audio.addEventListener("pause", () => {
                                this.isPlaying = false;
                                ctrl.tryApply();
                            });
                            // audio.addEventListener("loadedmetadata", function () {
                            //     ctrl.tryApply();
                            // });
                        },
                        // current song playing info
                        songInfo: undefined,
                        coverImgSrc: "",
                        currentExt: "",
                        defaultCoverImgUrl: "https://i.pinimg.com/736x/5a/e1/58/5ae15822d73ac828599044153fb91fed.jpg",
                        isRandomPlay: true,
                        loopMode: 0,
                        lyricLRCs: {
                            origin: undefined,
                            vs: undefined,
                            es: undefined,
                        },
                        isFavoriteList: false,
                        // set player song list
                        setPlaylist(songList) {
                            this._playlist = [...songList];
                            //set playlist
                            this.playlist = [...songList];
                            this.prevPlaylist = [];
                            this._favList = songList.filter((s) => s.isFavorite);
                            this.favList = [...this._favlist];
                            this.isOpen = true;
                            // this.audio.pause();
                        },
                        next() {
                            this._clearLyric();
                            if (this.playlist.length > 0) {
                                let rns = this._cache._rns;
                                if (rns.songInfo && this.isRandomPlay == rns.random && this.playlist.find((x) => x.fileId == rns.songInfo.fileId)) {
                                    console.log("play rns");
                                    this._cache.clearRns(false);

                                    this.refresh(rns.songInfo, rns.audio);
                                    return;
                                }

                                let songIn42Play;
                                if (this.isFavoriteList && this.playlist !== this.favlist) {
                                    this.favlist = [...this._favlist];
                                    this.playlist = this.favlist;
                                } else {
                                    if (this.playlist === this.favlist) {
                                        this.playlist = [...this._playlist];
                                    }
                                }
                                if (this.loopMode != 0 && this.songInfo) {
                                    console.log("play loop");

                                    this.audio.currentTime = 0;
                                    this.audio.play();
                                    if (this.loopMode == 1) {
                                        this.loopMode = 0;
                                    }
                                    return;
                                }
                                if (this.isRandomPlay) {
                                    songIn42Play = popRandomElement(this.playlist);
                                } else {
                                    songIn42Play = this.playlist.pop();
                                }
                                if (songIn42Play) {
                                    console.log("play df");

                                    this.refresh(songIn42Play);
                                    this.prevPlaylist.push(songIn42Play);
                                }
                            }
                        },
                        prev() {
                            let { current, duration } = this.in4;
                            if (current > 10) {
                                this.restart();
                                return;
                            }
                            if (this.prevPlaylist.length > 0) {
                                this.refresh(this.prevPlaylist.pop());
                            }
                        },
                        _clearLyric() {
                            document.getElementById("lyric").innerHTML = "";
                            document.getElementById("supLyric").innerHTML = "";
                            document.getElementById("vnLyric").innerHTML = "";
                            document.getElementById("enLyric").innerHTML = "";
                        },
                        // play button handler
                        play(s) {
                            this.refresh(s);
                        },
                        restart() {
                            this.audio.currentTime = 0;
                            this.audio.play();
                        },
                        updateLyric(timeAt = 0) {
                            timeAt = parseFloat(timeAt) + 0.25;
                            const { origin, es, vs } = this.lyricLRCs;
                            try {
                                let originSub = origin?.getLyrics(timeAt, ctrl.config.lyricAutoTranslate),
                                    vietsub = vs?.getLyrics(timeAt, ctrl.config.lyricAutoTranslate),
                                    engsub;
                                if (originSub) {
                                    document.getElementById("lyric").innerHTML = originSub;
                                    try {
                                        if (/[\u4e00-\u9fff]/.test(originSub)) {
                                            document.getElementById("supLyric").innerHTML = originSub
                                                .split(".")
                                                .map((s) => {
                                                    return s
                                                        .split(",")
                                                        .map((_s) => {
                                                            return pinyin
                                                                .pinyin(_s, {
                                                                    segment: true, // 启用分词
                                                                    group: true, // 启用词组
                                                                })
                                                                .map((p) => p[0])
                                                                .join(" ");
                                                        })
                                                        .join(", ")
                                                        .trim();
                                                })
                                                .join(". ")
                                                .trim();
                                        } else {
                                            document.getElementById("supLyric").innerHTML = "";
                                        }
                                    } catch (e) {
                                        console.log(e);
                                    }
                                } else {
                                    document.getElementById("lyric").innerHTML = "";
                                    document.getElementById("supLyric").innerHTML = "";
                                }
                                document.getElementById("vnLyric").innerHTML = vietsub && vietsub != originSub ? vietsub : "";
                            } catch (e) {
                                // this._clearLyric
                                console.log("update lyric err", e);
                            }
                        },
                        // reset playlist
                        resetPlaylist() {
                            this.playlist = [...this._playlist];
                            this.favList = [...this._favlist];
                            this.prevPlaylist = [];
                        },
                        _cache: {
                            _rns: {},
                            _rnsWk: false,
                            clearRns(revoke = true) {
                                try {
                                    if (revoke && this._rns.url) {
                                        // URL.revokeObjectURL(this._rns.url);
                                    }
                                } catch (e) {
                                    console.log(e);
                                }
                                this._rns = {};
                                this._rnsWk = false;
                            },
                        },
                        _readyNextSong() {
                            this._readyNextSong.idx = this._readyNextSong + 1 || 1;
                            let idx = this._readyNextSong.idx;
                            this._cache._rnsWk = true;
                            if (this.loopMode > 0) {
                                return;
                            }
                            if (this.playlist.length > 0) {
                                let songIn42Play;
                                if (this.isFavoriteList && this.playlist !== this.favlist) {
                                    this.favlist = [...this._favlist];
                                    this.playlist = this.favlist;
                                } else {
                                    if (this.playlist === this.favlist) {
                                        this.playlist = [...this._playlist];
                                    }
                                }
                                if (this.isRandomPlay) {
                                    songIn42Play = this.playlist[Math.floor(Math.random() * this.playlist.length)];
                                } else {
                                    songIn42Play = this.playlist[this.playlist.length - 1];
                                }
                                if (songIn42Play) {
                                    // console.log("ppfor ", songIn42Play);
                                    /// ready
                                    this._cache.clearRns(false);
                                    return (
                                        ctrl.MSService.getAudioSource(songIn42Play.fileId)
                                            // // let url = "https://www.googleapis.com/drive/v3/files/" + songIn42Play.fileId;
                                            // return fetch(url + "?alt=media&key=" + ctrl.selectKeyA_())
                                            //     .then((response) => response.blob())
                                            .then((blob) => {
                                                // console.log("rdn");
                                                let url = URL.createObjectURL(blob);
                                                let audio = new Audio(url);
                                                if (this._readyNextSong.idx != idx) return;
                                                return (this._cache._rns = {
                                                    songInfo: songIn42Play,
                                                    audio: audio,
                                                    url: url,
                                                    blob: blob,
                                                    random: this.isRandomPlay,
                                                });
                                            })
                                            .catch((err) => {
                                                // this._cache._rnsWk = false;
                                                console.log(err);
                                            })
                                    );
                                }
                            }
                        },
                        // set songinfo and play
                        refresh(songInfo, audio) {
                            if (ctrl.isReady()) {
                                let rfs = this.refresh.rfs ?? 0;
                                this.refresh.rfs = rfs;
                                this.refresh.playIndex = this.refresh.playIndex || 0;
                                const currentIndex = this.refresh.playIndex + 1;
                                this.refresh.playIndex = currentIndex;
                                try {
                                    if (songInfo.fileId == this._cache._rns.songInfo.fileId) {
                                        audio = this._cache._rns.audio;
                                    }
                                } catch (e) {}

                                this.songInfo = songInfo;
                                this.currentExt = "";
                                this.coverImgSrc = "";
                                this.in4.current = 0;
                                this.in4.duration = 0;
                                this.audio?.pause();
                                this.audio?.remove();
                                this.audio = new Audio("");
                                this._clearLyric();
                                if (audio) {
                                    this.refresh.rfs += 1;
                                    if (this.refresh.playIndex != currentIndex) return;

                                    this.lyricLRCs = {
                                        origin: new LyricLRC(songInfo.lyric),
                                        vs: new LyricLRC((songInfo.lyric_vn == "" || !songInfo.lyric_vn) && songInfo.lyric_vn_translated ? songInfo.lyric_vn_translated : songInfo.lyric_vn),
                                        // es: new LyricLRC(song.songInfo.lyric_en),
                                    };
                                    this.audio = audio;
                                    this.audio.title = this.mainSongName || this.subSongName;
                                    this.generateAudioEvent();
                                    this.audio.load();
                                    this.audio.play();
                                    this.refresh.rdn = false;
                                    this._cache._rnsWk = false;
                                    for (const [i, url] of urlRvk.entries()) {
                                        if (url != audio.src) {
                                            try {
                                                URL.revokeObjectURL(url);
                                                urlRvk.slice(i, 1);
                                            } catch (e) {
                                                console.log(e);
                                            }
                                        }
                                    }
                                    urlRvk.push(audio.src);
                                } else {
                                    clearTimeout(timer.loadSongAudioTimer);
                                    timer.loadSongAudioTimer = setTimeout(() => {
                                        ctrl.MSService.getAudioSource(songInfo.fileId)
                                            // fetch(this.audioSrc)
                                            //     .then((response) => response.blob())
                                            .then((blob) => {
                                                if (rfs != this.refresh.rfs) {
                                                    return blob;
                                                }
                                                this._cache.clearRns();
                                                let url = URL.createObjectURL(blob);
                                                let audio = new Audio(url);
                                                this._cache._rns = {
                                                    // songInfo: songInfo,
                                                    blob: blob,
                                                    audio: audio,
                                                    url: url,
                                                };
                                                this.refresh(songInfo, audio);
                                                ctrl.tryApply();
                                            });
                                    }, 2000);
                                }
                            }
                        },
                        playHandler(s, p) {
                            if (p) this.setPlaylist(p);
                            if (!s) {
                                if (this.songInfo) {
                                    if (this.audio.paused) {
                                        this.audio.play();
                                    } else {
                                        this.audio.pause();
                                    }
                                } else {
                                    this.next();
                                }
                            } else {
                                if (this.songInfo && s.fileId == this.songInfo.fileId) {
                                    if (this.audio.paused) {
                                        this.audio.play();
                                    } else {
                                        this.audio.pause();
                                    }
                                } else {
                                    this.play(s);
                                }
                                return;
                            }
                        },
                        speakerBtnHandle(value) {
                            this.in4.volume.isMuted = !this.in4.volume.isMuted;
                            if (!this.in4.volume.isMuted) {
                                this.setSpeakerValue(this.in4.volume.value);
                            } else {
                                this.audio.volume = 0;
                            }
                        },
                        loadMetadata() {
                            const player = this;
                            function processblob(blob) {
                                jsmediatags.read(blob, {
                                    onSuccess: function (tag) {
                                        player.currentExt = mimeTypeToExt(blob.type);
                                        const tags = tag.tags;
                                        const picture = tags.picture;
                                        console.log(tags);
                                        if (picture) {
                                            player.coverImgSrc = "data:" + picture.format + ";base64," + arrayBufferToBase64(picture.data);
                                            ctrl.tryApply();
                                        } else {
                                        }
                                    },
                                    onError: function (error) {
                                        console.log("err: " + JSON.stringify(error));
                                    },
                                });
                            }
                            fetch(player.audio.src)
                                .then((response) => response.blob())
                                .then((blob) => {
                                    processblob(blob);
                                })
                                .catch((error) => {
                                    console.error("Error fetching the file:", error);
                                });
                            return;
                        },
                        get mainSongName() {
                            try {
                                return this.songInfo.name == "" ? "" : `${this.songInfo.singer} - ${this.songInfo.name}`;
                            } catch (e) {
                                return "";
                            }
                        },
                        get subSongName() {
                            try {
                                return this.songInfo.vname == "" ? "" : `${this.songInfo.vsinger} - ${this.songInfo.vname}`;
                            } catch (e) {
                                return "";
                            }
                        },
                        showFc() {
                            closeAllPopover();
                            document.getElementById("player-fc").style.display = "block";
                        },
                        hideFc() {
                            closeAllPopover();
                            document.getElementById("player-fc").style.display = "none";
                        },
                    };
                    this.player.init($scope);
                    const managePlaylist = {
                        isOpen: false,
                        id: undefined,
                        name: "",
                        description: "",
                        songList: [],
                        playlist: undefined,
                        isLoading: false,
                        remove(s) {
                            this.songList = this.songList.filter((x) => x.fileId != s.fileId);
                        },
                        add: function (s) {
                            this.songList.push(s);
                        },
                        addHandler: function (s) {
                            if (this.isAdded(s)) {
                                this.remove(s);
                            } else {
                                this.add(s);
                            }
                        },
                        getPlaylist() {
                            return {
                                name: this.name,
                                description: this.description,
                                songList: this.songList,
                            };
                        },
                        push() {
                            let pl = this.getPlaylist();
                            this.isLoading = true;
                            if (!this.playlist) {
                                console.log("add");
                                return ctrl.DataService.addPlaylist(pl)
                                    .then((result) => {
                                        if (result) {
                                            if (!ctrl.user.playlist) {
                                                ctrl.user.playlist = [];
                                            }
                                            ctrl.user.playlist.push(pl);
                                            ctrl._lSupdate();
                                            ctrl.tryApply();
                                            alert("add ok" + JSON.stringify(result));
                                        } else {
                                            alert("add err" + result);
                                        }
                                        this.isLoading = false;
                                    })
                                    .catch((err) => {
                                        this.isLoading = false;
                                    });
                            } else {
                                return ctrl.DataService.updatePlaylist(pl)
                                    .then((result) => {
                                        if (result) {
                                            ctrl.user.playlist.map((x) => {
                                                copyObj(x, pl);
                                            });
                                            ctrl._lSupdate();
                                            ctrl.tryApply();
                                            alert("update ok");
                                        } else {
                                            alert("Update error \n " + result);
                                        }
                                        this.isLoading = false;
                                    })
                                    .catch((err) => {
                                        this.isLoading = false;
                                    });
                            }
                        },
                        isAdded(s) {
                            if (this.songList?.find((m) => m.fileId == s.fileId)) {
                                return true;
                            } else return false;
                        },
                        setPlaylist(_playlist) {
                            this.playlist = _playlist;
                            this.name = _playlist.name;
                            this.songList = angular.copy(_playlist.songList);
                            this.description = _playlist.description;
                            this.isOpen = true;
                        },
                        default() {
                            this.playlist = undefined;
                            this.name = "";
                            this.songList = [];
                            this.description = "";
                        },
                    };
                    const manageSong = {
                        _songInfo: {},
                        songInfo: {},
                        init(songInfo) {
                            this._songInfo = songInfo;
                            copyObj(this.songInfo, songInfo);
                            return this;
                        },
                        update() {
                            let s = {
                                ...this.songInfo,
                            };
                            loadingModal.show();

                            ctrl.DataService.updateSong(s)
                                .then((result) => {
                                    if (result) {
                                        ctrl.updateSongHanlder(s);
                                        alert("update ok ");
                                        if (s.fileId == this.songInfo.fileId) {
                                            copyObj(this.songInfo, s);
                                        }
                                        ctrl.tryApply();
                                    } else {
                                        alert("update err " + result);
                                    }
                                    loadingModal.hide();
                                })
                                .catch((err) => {
                                    alert("update err " + err);
                                    loadingModal.hide();
                                });
                        },
                        show() {
                            if (ctrl.user?.role != 0) {
                                // admin only
                                return;
                            }
                            $("#manageSongForm").modal("show");
                            $(".modal-backdrop").appendTo(".container.selfcontainer");
                            $(".modal-backdrop").width("97vw");
                            $("body").removeClass();
                            $("div.modal-backdrop.fade.show").hide();
                        },
                    };
                    this.form = {
                        managePlaylist: managePlaylist,
                        manageSong: manageSong,
                        login: {
                            username: "",
                            password: "",
                            push() {
                                ctrl.loginHandler(this);
                            },
                        },
                        register: {
                            username: "",
                            password: "",
                            push() {
                                ctrl.registerHandler(this);
                            },
                        },
                    };
                    this.init($scope);
                }

                init($scope) {
                    $scope.loading = true;
                    $scope.isSyncedLRC = (lrcString) => {
                        return new LyricLRC(lrcString).lyrics.data.length > 5;
                    };
                    let u = AuthService._getUS();
                    if (u && u != "null") {
                        this.user = u;
                        this.AuthService.getUserInfo()
                            .then((result) => {
                                console.log(result);
                                if (this.user && result) {
                                    this.user = result;
                                    this.tryApply();
                                }
                            })
                            .catch((err) => {
                                console.log(err);
                                this.user = AuthService._getUS();
                                this.tryApply();
                            });
                    }

                    this.loadSongCategory();
                    this.loadAllDrvAK();
                    // this.loadPlaylist();

                    if (this.sheet != "" && !this.sheet.startsWith("<") && !this.sheet.endsWith(">")) {
                        this.loadSongTable();
                    }

                    setTimeout(() => {
                        $scope.loading = false; // Hide the loader once data is loaded
                        this.tryApply();
                    }, 2000);
                }
                get songTable() {
                    if (!Array.isArray(this.songList)) {
                        this._lastSongTable = {};
                        return undefined;
                    }
                    const sortBy = this.sortBy || "name-asc";
                    const sheet = this.sheet || "";
                    const songList = this.songList || [];
                    const searchValue = this.searchValue;

                    if (this._lastSongTable) {
                        let { _sheet, _sortBy, _searchValue, _len } = this._lastSongTable;
                        if (_sortBy == sortBy && _searchValue == searchValue && songList.length == _len) {
                            return this._lastSongTable._data;
                        }
                    }

                    function checkSearchName(s, searchValue) {
                        return rmvVietnameseTones(`${s.vsinger} - ${s.vname} |  ${s.singer} - ${s.name}`).toLowerCase().includes(rmvVietnameseTones(searchValue).toLowerCase());
                    }
                    let songs = songList.filter((s) => !searchValue || checkSearchName(s, searchValue));
                    this._lastSongTable = this._lastSongTable || {};
                    this._lastSongTable._searchValue = searchValue;
                    this._lastSongTable._sortBy = sortBy;
                    this._lastSongTable._sheet = sheet;
                    this._lastSongTable._len = songList.length;
                    this._lastSongTable._data = this._lastSongTable._data || [];
                    this._lastSongTable._data.length = 0;

                    concatSelf(this._lastSongTable._data, ...songs);
                    // console.log(this._lastSongTable);
                    // console.log(songs);

                    if (sortBy) {
                        this._lastSongTable._data.sort((a, b) => {
                            switch (sortBy) {
                                case "name-asc":
                                    return compareObj(a, b, "name");
                                case "name-desc":
                                    return compareObj(b, a, "name");
                                case "singer-asc":
                                    return compareObj(a, b, "singer");
                                case "singer-desc":
                                    return compareObj(b, a, "singer");
                                case "listens-asc":
                                    return compareObj(a, b, "listens");
                                case "listens-desc":
                                    return compareObj(b, a, "listens");
                                default:
                                    return 0;
                            }
                        });
                    }
                    return this._lastSongTable._data;
                }
                updateSongHanlder(song) {
                    let orgS = this._songList.find((s) => s.fileId == song.fileId);
                    if (orgS) {
                        moveObj(orgS, song);
                    }
                }
                _lSupdate() {
                    AuthService._setUS(this.user);
                }
                isReady() {
                    if (this.keyList.length > 0) {
                        return true;
                    }
                    return false;
                }
                tryApply() {
                    try {
                        this.$scope.$apply();
                    } catch (e) {
                        // console.log("apply err " + e);
                    }
                }
                loadPlaylist() {
                    this.DataService.getAllPlaylist().then((result) => {
                        if (result) {
                            this.playlist = result;
                            this.tryApply();
                        }
                    });
                }
                loadSongCategory() {
                    this.DataService.getAllCategory().then((result) => {
                        this.sheetNames = result;
                        this.tryApply();
                    });
                }
                loadSongTable() {
                    this.songList = undefined;
                    this.menu.hidden = true;
                    this.message = `Loading song list of '${this.sheet}'`;
                    document.body.style.cursor = "wait";
                    this.sortBy = "";
                    let __w = this.sheet;
                    this.DataService.getSongsByCategory(__w, cfg.translateLyric).then((result) => {
                        this.message = ``;
                        if (__w == this.sheet) {
                            this._songList = [...result];
                            this.songList = [...result];
                            // this.player.setPlaylist(result);
                            this.tryApply();
                            document.body.style.cursor = "default";
                        }
                    });
                }
                loadAllDrvAK() {
                    this.DataService.getAllKeys().then((result) => {
                        this.keyList = result;
                        this.MSService.keyList = result;
                    });
                }
                getButtonLabel(name) {
                    if (name == this.sheet) {
                        return this.$sce.trustAsHtml("<u>" + name + "</u>"); // Use trusted HTML for rendering
                    } else {
                        return this.$sce.trustAsHtml(name);
                    }
                }
                selectSheetBtnHandler(name) {
                    this.sheet = name;
                    this.loadSongTable();
                }
                selectByDriveFolderHandler() {
                    let id = prompt("input folder id or url");
                    if (id?.startsWith("https")) {
                        id = extractFolderId(id);
                    }
                    if (/^[a-zA-Z0-9-_]{33}$/.test(id || "")) {
                        this.sheet = id;
                        this.loadSongTable();
                        return;
                    }
                    if (id) alert("invalid folder got ", id);
                }
                playSongList() {
                    this.player.setPlaylist([...this.songList]);
                    this.player.next();
                }
                playPlaylistHandler(p) {
                    this.form.managePlaylist.setPlaylist(p);
                    this.player.setPlaylist([...p.songList]);
                    this.player.next();
                }
                removePlaylistBtnHandler(pl) {
                    if (localStorage.getItem("authToken") == null || localStorage.getItem("authToken") == "") {
                        return alert("Not authorized");
                    }
                    const ctrl = this;
                    if (confirm("Confirm delete playlist " + pl.name)) {
                        this.DataService.removePlaylist(pl).then((result) => {
                            this.playlist.filter((x) => x.id != pl.id);
                            this.tryApply();
                            alert("remove ok");
                        });
                    }
                }
                showCreatePlaylistForm() {
                    this.form.managePlaylist.isOpen = !this.form.managePlaylist.isOpen;
                    this.form.managePlaylist.default();
                }
                selectPlaylistBtnHandler(p) {
                    this.form.managePlaylist.setPlaylist(p);
                }
                favoriteBtnHandler(song) {
                    if (localStorage.getItem("authToken") == null || localStorage.getItem("authToken") == "") {
                        return alert("Not authorized");
                    }
                    if (song.fileId.length == 33) {
                        song.isLoadingFav = true;
                        if (this.user.favorite?.includes(song.fileId)) {
                            this.DataService.rmvFavoriteSong(song)
                                .then((result) => {
                                    if (result) {
                                        this.user.favorite.splice(this.user.favorite.indexOf(song.fileId), 1);
                                        AuthService._setUS(this.user);
                                    } else {
                                        alert("favoriteBtnHandler err: unknown " + ": got result= \n" + result);
                                    }
                                    song.isLoadingFav = false;
                                    this.tryApply();
                                })
                                .catch((err) => {
                                    song.isLoadingFav = false;
                                    this.tryApply();
                                    alert(err);
                                });
                        } else {
                            this.DataService.setFavoriteSong(song)
                                .then((result) => {
                                    if (result) {
                                        this.user.favorite.push(song.fileId);
                                        AuthService._setUS(this.user);
                                    } else {
                                        alert("favoriteBtnHandler err: unknown " + ": got result= \n" + result);
                                    }
                                    song.isLoadingFav = false;
                                    this.tryApply();
                                })
                                .catch((err) => {
                                    song.isLoadingFav = false;
                                    this.tryApply();
                                    alert(err);
                                });
                        }
                    }
                }

                homeSelectCategoryHandler(name) {
                    this.selectSheetBtnHandler(name);
                }
                selectKeyA_() {
                    if (this.keyList) {
                        this.selectKeyA_.lastKeyIdx = ((this.selectKeyA_.lastAudioIndex ?? -1) + 1) % this.keyList.length;
                        return this.keyList[this.selectKeyA_.lastKeyIdx];
                    }
                }
                loginHandler({ username, password }) {
                    if (username && password) {
                        loadingModal.show();
                        let token = this.AuthService.login({ username: username, password: password })
                            .then((result) => {
                                if (result) {
                                    this.user = result.user;
                                    this.tryApply();
                                    loadingModal.hide();
                                } else {
                                    console.log(result);
                                }
                            })
                            .catch((err) => {
                                loadingModal.hide();
                                alert("login err");
                            });
                    }
                }
                registerHandler({ username, password }) {
                    if (username && password) {
                        loadingModal.show();

                        let token = this.AuthService.signup({ username: username, password: password })
                            .then((result) => {
                                if (result) {
                                    this.user = result.user;
                                    this.tryApply();
                                    alert("registerHandler Ok");
                                    loadingModal.hide();
                                } else {
                                    console.log(result);
                                }
                            })
                            .catch((err) => {
                                loadingModal.hide();
                                alert("registerHandler err");
                            });
                    }
                }
                logout() {
                    AuthService.logout();
                    this.user = undefined;
                }
            }
            class Service {
                constructor($http) {
                    this.$http = $http;
                    this.rpcServer = "https://script.google.com/macros/s/AKfycbz1FHLLdtpW5hba-4NlD0l-tqqBpdZ4EbvYuRAC2GfTU5g_RR6pHgti3trJ0nWkwoVOFA/exec";
                }

                query(methodName, params) {
                    let prm;
                    if (isAppsScript) {
                        prm = appsScriptRunAsync("simulateJSONRpcCall", [methodName, JSON.parse(angular.toJson(params)), AuthService.getAuthToken()]);
                    } else {
                        prm = this.$http
                            .post(this.rpcServer, {
                                jsonrpc: "2.0",
                                method: methodName,
                                params: params,
                                authToken: AuthService.getAuthToken(),
                            })
                            .then((response) => response.data);
                    }

                    return prm
                        .then((data) => {
                            // console.log(data);
                            if ("result" in data) {
                                return data.result;
                            }
                            if ("error" in data) {
                                throw new Error("jsonrpc err:" + JSON.stringify(data));
                            }
                        })
                        .catch((err) => {
                            console.log("post err" + err);
                            throw new Error("err :" + methodName + " " + err);
                        });
                }
            }
            class AuthService extends Service {
                constructor($http) {
                    super($http);
                }
                static _getAT() {
                    return localStorage.getItem("authToken");
                }
                static _getUS() {
                    try {
                        return JSON.parse(localStorage.getItem("user"));
                    } catch (e) {
                        console.log(e + "geet user err");
                    }
                }
                static _setAT(v) {
                    return localStorage.setItem("authToken", v);
                }
                static _setUS(u) {
                    // if (u) {
                    //     console.log(u)
                    //     console.log(u)
                    // }
                    return localStorage.setItem("user", u ? JSON.stringify(u) : null);
                }
                static logout() {
                    this._setAT();
                    this._setUS();
                    return "";
                }
                static getAuthToken() {
                    try {
                        let token = this._getAT();
                        let user = this._getUS();
                        if (token == null || token == "" || token == "undefined" || user == null || user == "") return this.logout();
                        if (new Date().getTime() > token.split("::").pop()) {
                            return this.logout();
                        }
                        // return `${token.split("::")[0]}::${user.username}::${user.role}::${token.split("::")[1]}`;
                        return token;
                    } catch (e) {
                        console.log("getToken err" + e);
                        return this.logout();
                    }
                }
                login({ username, password }) {
                    return this.query("login", [{ username, password }])
                        .then((result) => {
                            if (result) {
                                AuthService._setAT(result.token);
                                AuthService._setUS(result.user);
                                alert("Login OK");
                                return result;
                            } else {
                                alert("LoginFailer");
                            }
                        })
                        .catch((err) => {
                            alert("Login err: " + JSON.stringify(err));
                        });
                }

                signup({ username, password }) {
                    return this.query("register", [{ username, password }])
                        .then((result) => {
                            if (result) {
                                AuthService._setAT(result.token);
                                AuthService._setUS(result.user);
                                alert("register OK");
                                return result;
                            } else {
                                alert("registerFailer");
                            }
                        })
                        .catch((err) => {
                            alert("register err: " + JSON.stringify(err));
                        });
                }
                getUserInfo() {
                    return this.query("getUserInfo", []).then((result) => {
                        if (result) {
                            AuthService._setUS(result);
                        }
                        return result;
                    });
                }
            }
            class DataService extends Service {
                constructor($http) {
                    super($http);
                }
                getSongsByCategory(categoryName, translate = false) {
                    return this.query("getSongs", [categoryName, translate]);
                }
                getAllCategory() {
                    return this.query("getAllSheetName", []);
                }
                getAllKeys() {
                    return this.query("getAllApiKey", []);
                }
                // @_Service.requireAuthToken
                setFavoriteSong(song) {
                    return this.query("setFavoriteSong", [song.fileId]);
                }
                rmvFavoriteSong(song) {
                    return this.query("rmvFavoriteSong", [song.fileId]);
                }
                // @_Service.requireAuthToken
                updateSong(s) {
                    return this.query("updateSong", [s]);
                }
                getAllPlaylist() {
                    return this.query("getPlaylist", []);
                }
                addPlaylist(playlist) {
                    return this.query("addPlaylist", [playlist]);
                }
                // @_Service.requireAuthToken
                removePlaylist(playlist) {
                    return this.query("removePlaylist", [playlist]);
                }
                // @_Service.requireAuthToken
                updatePlaylist(playlist) {
                    return this.query("updatePlaylist", [playlist]);
                }
                addListens(songInfo) {
                    return this.query("addListens", [songInfo]);
                }
            }
            class MusicSourceService extends Service {
                constructor($http, keyList = []) {
                    super($http);
                    this.keyList = keyList;
                }
                getAudioSource(fileId) {
                    if (true) {
                        // if (isAppsScript) {
                        return fetch("https://www.googleapis.com/drive/v3/files/" + fileId + "?alt=media&key=" + this.selectKeyA_()).then((response) => response.blob());
                    } else {
                        return this.query("getAudio", [fileId]).then((result) => {
                            if (result) {
                                return base64ToBlob(result);
                            }
                        });
                    }
                }
                selectKeyA_() {
                    if (this.keyList) {
                        this.selectKeyA_.lastKeyIdx = ((this.selectKeyA_.lastAudioIndex ?? -1) + 1) % this.keyList.length;
                        return this.keyList[this.selectKeyA_.lastKeyIdx];
                    }
                }
            }
            var app = angular.module("musicApp", ["ngSanitize"]);
            app.service("DataService", ["$http", DataService]);
            app.service("AuthService", ["$http", AuthService]);
            app.controller("MusicAppController", ["$scope", "$sce", "$timeout", "$http", "DataService", "AuthService", MusicAppController]);
        </script>
        <script>
            // utils
            function popRandomElement(arr) {
                if (arr.length === 0) return undefined;
                const randomIndex = Math.floor(Math.random() * arr.length);
                const [removedElement] = arr.splice(randomIndex, 1);
                return removedElement;
            }
            function arrayBufferToBase64(buffer) {
                let binary = "";
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
            function rmvVietnameseTones(str) {
                str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                str = str.replace(/đ/g, "d").replace(/Đ/g, "D");
                return str;
            }
            function compareObj(a, b, p) {
                try {
                    if (a[p] > b[p]) return 1;
                    if (a[p] < b[p]) return -1;
                } catch (e) {}
                return 0;
            }
            function copyObj(a, b) {
                for (const [k, v] of Object.entries(b)) {
                    a[k] = v;
                }
                return a;
            }
            function moveObj(a, b) {
                for (const [k, v] of Object.entries(b)) {
                    if (!k.includes("$") && k != "_id") {
                        a[k] = v;
                    }
                }
                return a;
            }
            function secToMin(seconds) {
                seconds = parseInt(seconds);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${String(minutes).padStart(2, "0")}:${String(remainingSeconds).padStart(2, "0")}`;
            }
            function base64ToBlob(base64String, contentType = "") {
                let base64Data = base64String;
                if (base64String.includes(",")) {
                    const parts = base64String.split(",");
                    const mimeMatch = parts[0].match(/:(.*?);/);
                    contentType = mimeMatch ? mimeMatch[1] : "application/octet-stream";
                    base64Data = parts[1];
                }
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: contentType });
            }
            var concatSelf = function (_this, ...arrays) {
                for (const items of arrays.flat()) {
                    _this.push(items);
                }
            };
            function mimeTypeToExt(mimeType) {
                const audioMimeTypes = {
                    "audio/mpeg": "MP3",
                    "audio/mp4": "MP4",
                    "audio/wav": "WAV",
                    "audio/x-wav": "WAV",
                    "audio/ogg": "OGG",
                    "audio/webm": "WEBM",
                    "audio/flac": "FLAC",
                    "audio/x-flac": "FLAC",
                    "application/x-flac": "FLAC",
                    "audio/aac": "AAC",
                    "audio/x-aiff": "AIFF",
                    "audio/basic": "AU",
                    "audio/midi": "MID",
                    "audio/x-midi": "MID",
                    "audio/x-ms-wma": "WMA",
                    "audio/x-matroska": "MKA",
                    "audio/vnd.rn-realaudio": "RA",
                    "audio/vnd.wave": "WAV",
                    "audio/3gpp": "3GP",
                    "audio/3gpp2": "3G2",
                    "audio/ac3": "AC3",
                    "audio/x-pn-realaudio": "RM",
                };
                return audioMimeTypes[mimeType] || mimeType;
            }
            function extractFolderId(url) {
                try {
                    const match = url.match(/folders\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        return match[1];
                    }
                } catch (e) {
                    return null;
                }
                return null;
            }
        </script>
    </body>
</html>
