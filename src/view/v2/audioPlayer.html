<!DOCTYPE html>
<html lang="en" ng-app="musicApp">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                font-size: small;
                margin: 0;
                padding: 0;
                background-color: rgb(201, 242, 255);
            }

            .maincontent {
                display: block;
            }

            .toppp {
                position: fixed;
                /* Make the element fixed */
                top: 0;
                left: 0;
                width: 100%;
                color: white;
                text-align: center;
                align-items: center;
                background-color: rgb(201, 242, 255);
                border: 10px;
                border-color: aliceblue;
                /* padding: 10px 0; */
                z-index: 1000;
            }

            .songImage {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .middd {
                padding: 20px;
                margin-right: 10%;
                margin-left: 10%;
                margin-top: 20px;
                margin-bottom: 8%;
            }

            .tabledpl {
                display: flex;
            }

            .songstable {
                margin-left: 20px;
                margin-right: 20px;
            }

            table {
                width: 100%;
                background-color: aliceblue;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid black;
                padding: 8px;
                text-align: left;
            }

            caption {
                font-weight: bold;
                margin: 10px 0;
            }

            #navbar {
                color: black;
                font-weight: bold;
                font-size: larger;
                display: inline;
            }

            #navbar > button {
                margin-right: 20px;
            }
        </style>
        <style>
            .footer > button {
                z-index: 11000;
                position: fixed;
                right: 1%;
                left: auto;
                bottom: 3%;
            }
        </style>
        <style>
            .audioplayer-bottom-fixed {
                display: flex;
                position: fixed;
                align-items: center;
                left: 0;
                bottom: 0;
                width: 100%;
                height: 8%;
                background-color: #333;
                color: beige;
                text-align: left;
                padding: 10px;
                /* box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3); */
            }
            .song-info {
                display: flex;
                margin-left: 3%;
                width: 45%;
                height: 100%;
            }
            .mainSongName {
                margin-top: 6px;
                font-size: large;
                width: auto;
            }
            .subSongName {
                margin-top: 6px;
                font-size: small;
                font-weight: normal;
                width: auto;
            }
            .song-player {
                margin-left: 5%;
                display: inline;
            }
            .audio-player {
                display: flex;
                height: 100%;
                width: 100%;
                margin-top: 6px;
            }
            .audio-action {
                display: inline;
                width: auto;
                margin-left: 5%;
                align-items: center;
            }
            .wrap-audio-controls > button {
                width: auto;
                margin-top: 10px;
                margin-right: 10px;
                display: inline-flex;
                min-width: 55px;
                text-align: center;
                justify-content: center;
            }
            .player-input {
                margin-top: 5px;
                display: flex;
                align-items: center;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-sanitize.min.js"></script>
        <!-- Include angular-sanitize -->
        <script>
            function appsScriptRun({
                funtionName,
                input = [],
                userObj,
                onSuccess = (result, userObj = undefined) => {
                    console.log("success" + result);
                },
                onError = (result, userObj = undefined) => {
                    console.log("fail" + result);
                },
            }) {
                let runner = google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onError);
                if (userObj) {
                    runner.withUserObject(userObj);
                }
                runner[funtionName](...input);
            }

            const isAppsScript = window.location.host.endsWith("-script.googleusercontent.com");
            const isiOS = ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"].includes(navigator.platform) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        </script>
    </head>
    <body ng-controller="MusicAppController as ctrl">
        <div class="toppp">
            <div class="">
                <div id="navbar" ng-repeat="name in ctrl.sheetNames">
                    <button name="workingSheet" ng-value="name" ng-bind-html="ctrl.getButtonLabel(name)" ng-click="ctrl.selectSheetBtnHandler(name)"></button>
                </div>
            </div>
        </div>
        <div class="middd" id="middd">
            <div class="table">
                <!-- <button type="button" onclick="selectTable(event)" value="songs">songList</button>
                <button type="button" onclick="selectTable(event)" value="playlist">current playlist</button> -->
                <div>{{ctrl.message}}</div>
                <div class="tabledpl">
                    <div class="songstable" id="songs">
                        <table>
                            <tr ng-repeat="s in ctrl.songList">
                                <!-- <td>{{i + 1}}</td> -->
                                <td>{{s.vname == "" ? s.name : s.vname}}</td>
                                <td>{{s.vsinger == "" ? s.singer : s.vsinger}}</td>

                                <td>
                                    <button name="play" ng-value="s.fileId" ng-click="ctrl.player.play(s)">play</button>
                                    <button ng-click="ctrl.setSongFavorite($event, s.fileId)">{{s.isFavorite ? 'Remove fav' : 'Add fav'}}</button>
                                    <!-- <button name="addtoplaylist" ng-value="s.fileId" ng-click="addToPlaylistBtnHandler(event)">addPL</button>
                                    <input type="checkbox" name="songcheckbox" ng-value="s.fileId" /> -->
                                    <div ng-if="ctrl.isiOS" hidden>
                                        <audio preload="auto">
                                            <source src="" />
                                        </audio>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="songstable" id="playlist"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <button onclick="hideshowAudioPlayer(event)" id="hideshowPlayerBtn">ClosePlayer</button>
            <script>
                function hideshowAudioPlayer(event) {
                    let pler = document.getElementById("bottom-audio-player");

                    if (pler.style.display == "none") {
                        pler.style.display = "";
                        event.target.innerText = "ClosePlayer";
                    } else {
                        pler.style.display = "none";
                        event.target.innerText = "OpenPlayer";
                    }
                }
            </script>
        </div>

        <div class="audioplayer-bottom-fixed" id="bottom-audio-player">
            <div class="song-info">
                <div><img ng-src="{{ ctrl.player.coverImgUrl ?  ctrl.player.coverImgUrl : ctrl.player.defaultCoverImgUrl }}" width="60" height="60" id="currentSongImg" /></div>
                <div class="song-player">
                    <div class="mainSongName">{{ctrl.player.mainSongName}}</div>
                    <div class="subSongName">{{ctrl.player.subSongName}}</div>
                </div>
            </div>
            <div class="audio-player">
                <audio id="audioPlayer" controls autoplay controlsList="nodownload">
                    <source ng-src="{{ ctrl.player.audioSrc  }}" type="audio/flac" />
                </audio>
                <div class="audio-action">
                    <div class="wrap-audio-controls">
                        <button ng-click="ctrl.player.playHandler($event)" id="playbtn">Play</button>
                        <!-- {{ctrl.player.audio.paused ? "Play" : "Pause"}} -->
                        <button ng-click="ctrl.player.prev()">Previous</button>
                        <button ng-click="ctrl.player.next()">Next</button>
                        <button ng-click="ctrl.player.restart()">Restart</button>
                        <button ng-click="ctrl.setSongFavorite($event, ctrl.player.songInfo.fileId)">{{ ctrl.player.songInfo.isFavorite ? 'Remove fav' : 'Add fav' }}</button>
                        <button ng-click="ctrl.player.resetPlaylist()">Reset Playlist</button>
                    </div>

                    <div class="player-input">
                        <div>
                            <input type="checkbox" ng-model="ctrl.player.isRandomPlay" checked />
                            <label for="isRandomPlay"> Play random </label>
                        </div>
                        <div>
                            <input type="checkbox" ng-model="ctrl.player.isLoopPlay" />
                            <label for="isLoopPlay"> Play loop </label>
                            <!-- <input style="width: 30px" type="number" ng-model="timeLoop" /> timeLoop -->
                        </div>
                        <div>
                            <input type="checkbox" ng-model="ctrl.player.isFavoriteList" />
                            <label for="isFavoriteList"> Play favorite </label>
                            <!-- <input style="width: 30px" type="number" ng-model="timeLoop" /> timeLoop -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js" integrity="sha512-YsR46MmyChktsyMMou+Bs74oCa/CDdwft7rJ5wlnmDzMj1mzqncsfJamEEf99Nk7IB0JpTMo5hS8rxB49FUktQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>
            const audio = document.getElementById("audioPlayer");
            const bottomAudioPlayer = document.getElementById("bottom-audio-player");
            audio.addEventListener("play", () => {
                document.getElementById("playbtn").innerText = "Pause";
            });
        </script>
        <script>
            class MusicAppController {
                constructor($scope, $sce, $timeout, DataService) {
                    const ctrl = this;
                    this.DataService = DataService;
                    this.$timeout = $timeout;
                    this.$scope = $scope;
                    this.$sce = $sce;
                    // this.fileId = "<?= fileId?>";
                    this.sheet = "<?= sheet?>";
                    // this.host = "<?= host?>";
                    this.message = "hello";
                    this.keyList = [];
                    this.songList = [{ fileId: "testfileId", vname: "testvname", vsinger: "testvsinger" }];

                    audio.addEventListener("ended", () => {
                        ctrl.player.next();
                        try {
                            ctrl.$scope.$apply();
                        } catch (e) {
                            console.log(e);
                        }
                    });
                    audio.addEventListener("canplay", () => {
                        ctrl.player.fetchMetadata(audio.src);
                        try {
                            ctrl.$scope.$apply();
                        } catch (e) {
                            console.log(e);
                        }
                    });

                    this.loadSongTable();
                    this.loadSongCategory();
                    this.loadAllDrvAK();
                    // this.isiOS = isiOS;
                    // music player controll
                    this.player = {
                        _playlist: [],
                        _favList: [],
                        playList: [],
                        prevPlaylist: [],
                        favList: [],
                        // audio element
                        audio: audio,
                        // current song playing info
                        songInfo: { name: "", singer: "", vname: "", vsinger: "", isFavorite: false, fileId: "", sheet: "" },
                        coverImgSrc: "",
                        defaultCoverImgUrl: "https://img.freepik.com/premium-vector/realistic-vinyl-disc-mockup-empty-blank-music-album-cover-isolated-white-background-retro-musical-long-play-white-template-paper-box-3d-vector-illustration_341509-1731.jpg",
                        isRandomPlay: true,
                        isLoopPlay: false,
                        // set player song list
                        setPlaylist: function (songList) {
                            this._playlist = songList;
                            //set playlist
                            this.playList = songList;
                            this.prevPlaylist = [];
                            this._favList = songList.filter((s) => s.isFavorite);
                            this.favList = this._favList;
                        },
                        next: function () {
                            if (this.playList.length > 0) {
                                let songIn42Play;
                                // console.log(this.isRandomPlay + " " + this.isLoopPlay);
                                // console.log(this.playList);
                                if (this.isLoopPlay) {
                                    this.audio.currentTime = 0;
                                    this.audio.play();
                                    return;
                                }
                                if (this.isRandomPlay) {
                                    songIn42Play = popRandomElement(this.playList);
                                } else {
                                    songIn42Play = this.playList.pop();
                                }
                                if (songIn42Play) {
                                    this.refresh(songIn42Play);
                                    this.prevPlaylist.push(songIn42Play);
                                }
                            }
                        },
                        prev: function () {
                            if (this.prevPlaylist.length > 0) {
                                this.refresh(this.prevSongList.pop());
                            }
                        },
                        // play button handler
                        play: function (s) {
                            bottomAudioPlayer.style.display = "";
                            this.refresh(s);
                        },
                        restart: function () {
                            this.audio.currentTime = 0;
                            this.audio.play();
                        },
                        // reset playlist
                        resetPlaylist: function () {
                            this.playList = this._playlist;
                            this.favList = this._favList;
                            this.prevPlaylist = [];
                        },
                        // set songinfo and play
                        refresh: function (songInfo) {
                            if (ctrl.isReady()) {
                                console.log(songInfo);
                                this.songInfo = songInfo;
                                this.coverImgSrc = "";
                                this.audio.load();
                                this.audio.play();
                            }
                        },
                        playHandler: function (event) {
                            if (this.audio.paused) {
                                this.audio.play();
                                event.target.innerText = "Pause";
                            } else {
                                this.audio.pause();
                                event.target.innerText = "Play";
                            }
                        },
                        fetchMetadata: function (url, onCompleted = console.log) {
                            const ins = this;
                            fetch(url, { headers: { Range: "bytes=0-1000000" } })
                                .then((response) => response.arrayBuffer())
                                .then((buffer) => {
                                    jsmediatags.read(new Blob([buffer]), {
                                        onSuccess: function (tag) {
                                            const tags = tag.tags;
                                            const picture = tags.picture;
                                            if (picture) {
                                                const base64String = arrayBufferToBase64(picture.data);
                                                const base64 = "data:" + picture.format + ";base64," + base64String;
                                                ins.coverImgSrc = base64;
                                            } else {
                                            }
                                        },
                                        onError: function (error) {},
                                    });
                                })
                                .catch((error) => {
                                    console.error("Error fetching the file:", error);
                                });
                        },
                        get mainSongName() {
                            return this.songInfo.vname == "" ? "" : `${this.songInfo.singer} - ${this.songInfo.name}`;
                        },
                        get subSongName() {
                            return this.songInfo.vname == "" ? "" : `${this.songInfo.vsinger} - ${this.songInfo.vname}`;
                        },
                        get audioSrc() {
                            if (this.songInfo.fileId == "") return "";
                            return "https://www.googleapis.com/drive/v3/files/" + this.songInfo.fileId + "?alt=media&key=" + ctrl.selectKeyA_();
                        },
                    };

                    $scope.player = this.player;
                }

                isReady() {
                    if (this.keyList.length > 0 && this.songList) {
                        return true;
                    }
                    return false;
                }
                load() {}
                loadSongCategory() {
                    this.DataService.getAllCategory().then((result) => {
                        this.sheetNames = result;
                        this.$scope.$apply();
                    });
                    // appsScriptRun({
                    //     funtionName: "getAllSheetName",
                    //     onSuccess: (result) => {
                    //         this.sheetNames = result;
                    //         this.$scope.$apply();
                    //     },
                    // });
                }
                loadSongTable() {
                    this.songList = [];
                    this.message = `Loading song list of '${this.sheet}'`;
                    this.DataService.getSongsByCategory(this.sheet).then((result) => {
                        this.message = ``;
                        this.songList = result;
                        this.player.playList = result;
                        this.$scope.$apply();
                    });
                    // appsScriptRun({
                    //     funtionName: "getAllSongAndId",
                    //     input: [this.sheet],
                    //     onSuccess: (result) => {
                    //         this.message = ``;
                    //         this.songList = result;
                    //         this.player.playList = result;
                    //         this.$scope.$apply();
                    //     },
                    // });
                }
                loadAllDrvAK() {
                    this.DataService.getAllKeys().then((result) => {
                        this.keyList = result;
                    });
                    // appsScriptRun({
                    //     funtionName: "getAllApiKey",
                    //     onSuccess: (result) => {
                    //         this.keyList = result;
                    //     },
                    // });
                }
                getButtonLabel(name) {
                    if (name == this.sheet) {
                        return this.$sce.trustAsHtml("<u>" + name + "</u>"); // Use trusted HTML for rendering
                    } else {
                        return this.$sce.trustAsHtml(name);
                    }
                }

                selectSheetBtnHandler(name) {
                    this.sheet = name;
                    this.loadSongTable();
                }

                setFavoriteSong($event, fileId) {
                    if (fileId.length == 33) {
                        // console.log(fileId);
                        let songInfo = this.songList.find((s) => s.fileId == fileId);
                        let isFav = songInfo.isFavorite;

                        this.DataService.setFavoriteSong().then((result) => {
                            if (result) {
                                songInfo.isFavorite = !isFav;
                                if (fileId == this.player.songInfo.fileId) {
                                    this.player.songInfo = songInfo;
                                }
                                this.$scope.$apply();
                            }
                        });

                        // appsScriptRun({
                        //     funtionName: "setSongFavorite",
                        //     input: [this.sheet, fileId, !isFav],
                        //     onSuccess: (result) => {
                        //         if (result) {
                        //             songInfo.isFavorite = !isFav;
                        //             if (fileId == this.player.songInfo.fileId) {
                        //                 this.player.songInfo = songInfo;
                        //             }
                        //             this.$scope.$apply();
                        //         }
                        //     },
                        // });
                    }
                }

                selectKeyA_() {
                    if (this.isReady()) {
                        this.selectKeyA_.lastKeyIdx = ((this.selectKeyA_.lastAudioIndex ?? -1) + 1) % this.keyList.length;
                        return this.keyList[this.selectKeyA_.lastKeyIdx];
                    }
                }

                showAndroidNotification(songInfo) {
                    // NOT WORK ON SCRIPT.GOOGLE.COM IFRAME
                }
                showIOSNotification(songInfo) {
                    // NOT WORK ON SCRIPT.GOOGLE.COM IFRAME
                }
            }

            // SERVICE
            class DataService {
                constructor($http) {
                    this.$http = $http;
                    this.apiServer = "";
                }
                getSongsByCategory(categoryName) {
                    if (isAppsScript) {
                        return appsScriptRunAsync("getAllSongAndId", [categoryName])
                            .then((res) => {
                                return res;
                            })
                            .catch((err) => {
                                console.log(err, categoryName);
                            });
                    }
                }

                getAllCategory() {
                    if (isAppsScript) {
                        return appsScriptRunAsync("getAllSheetName", [])
                            .then((res) => {
                                return res;
                            })
                            .catch((err) => {
                                console.log(err, categoryName);
                            });
                    } else {
                        // impl api fetch
                    }
                }

                getAllKeys(param) {
                    if (isAppsScript) {
                        return appsScriptRunAsync("getAllApiKey", [])
                            .then((res) => {
                                return res;
                            })
                            .catch((err) => {
                                console.log(err, categoryName);
                            });
                    } else {
                        // impl api fetch
                    }
                }

                setFavoriteSong(categoryName, fileId, isFav) {
                    if (isAppsScript) {
                        return appsScriptRunAsync("setSongFavorite", [categoryName, fileId, isFav])
                            .then((res) => {
                                return res;
                            })
                            .catch((err) => {
                                console.log(err, categoryName);
                            });
                    } else {
                        // impl api fetch
                    }
                }
            }
            var app = angular.module("musicApp", ["ngSanitize"]);
            app.service("DataService", ["$http", DataService]);
            app.controller("MusicAppController", ["$scope", "$sce", "$timeout", "DataService", MusicAppController]);
        </script>
        <script>
            async function appsScriptRunAsync(functionName, args) {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        [functionName](...args);
                });
            }
            // utils
            function popRandomElement(arr) {
                if (arr.length === 0) {
                    return undefined; // Return undefined if the array is empty
                }

                const randomIndex = Math.floor(Math.random() * arr.length);
                const [removedElement] = arr.splice(randomIndex, 1);

                return removedElement;
            }
            function arrayBufferToBase64(buffer) {
                let binary = "";
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
        </script>

        <script></script>
    </body>
</html>
